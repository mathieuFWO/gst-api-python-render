<!-- v38.21 - Modifié 6 -->
<head>
  <meta charset="UTF-8">
  <title>Calculateur Test A/B – Analyse séquentielle (v38.21 - Modifié 6)</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <!-- Highcharts JS -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
  <script src="https://code.highcharts.com/modules/bullet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
  <!-- Custom Styles -->
  <style>
    /* --- Variables --- */
    :root {
      --primary-color: #005ff8;
      --secondary-color: #495057;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107; 
      --info-color: #005ff8; 
      --light-gray: #f8f9fa;
      --medium-gray: #e9ecef;
      --dark-gray: #343a40;
      --lift-default-color: #555;
      --lift-win-color: #028D6A;
      --lift-loss-color: #EB5757;
      --border-color: #dee2e6;
      --input-border-color: #bbb;
      --separator-color: #DDD;
      --input-bg: #fff;
      --section-bg: #fff;
      --right-col-bg: #EEF4F4;
      --font-family-base: 'Poppins', sans-serif;
      --tooltip-bg: #333;
      --tooltip-text: #fff;
      --secondary-metric-ok-bg: #e7f7ec;
      --secondary-metric-ok-border: #b8e9c7;
      --secondary-metric-ok-text: #196e3e;
      --secondary-metric-warn-bg: #fff3cd;
      --secondary-metric-warn-border: #ffeeba;
      --secondary-metric-warn-text: #856404;
      --srm-ok-color: var(--success-color);
      --srm-error-color: var(--danger-color);
      --discussion-color-bg: #fff8e1; 
      --discussion-color-text: #8d6e63; 
      --discussion-color-border: #ffecb3;
      /* AJOUT START: Couleurs pour la jauge de progression */
      --progress-gauge-done-color: #4CC289;
      --progress-gauge-todo-color: #eef4f4;
      /* AJOUT END */
      /* AJOUT START: Couleurs pour le tableau de gain estimé */
      --gain-positive-bg: #eef4f4; /* Très léger gris/vert */
      --gain-positive-text: #028D6A;
      --gain-negative-bg: #F9EFF2; /* Très léger rose/rouge */
      --gain-negative-text: #EB5757;
      /* AJOUT END */
    }

/* --- Global Styles --- */
body { font-family: var(--font-family-base); color: var(--secondary-color); background-color: #f4f7f6; }
h1, h2, h4, h5, h6 { font-family: var(--font-family-base); color: var(--dark-gray); margin-top: 1.5em; margin-bottom: 0.8em; font-weight: 600; }
h1 { font-size: 2.0rem; font-weight: 700; margin-bottom: 20px; margin-top:20px; }
h2 { font-size: 1.5rem; border-bottom: 1px solid var(--medium-gray); padding-bottom: 0.4em; }
h3 { font-size: 1.4rem; font-weight: 600; color: var(--dark-gray); margin-top: 1em; margin-bottom: 0.7em; padding-bottom: 0.3em;}
h4 { font-size: 1.1rem; font-weight: 600; color: var(--primary-color); margin-top: 1.4em; margin-bottom: 1em; }
.section { background: var(--section-bg); margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1) !important; border-radius: 5px; border: 1px solid var(--border-color);padding:20px; }
a#toggle-history-table {text-decoration: underline;font-weight: 600;}
div#mainAccordion{padding: 0px; box-shadow: none;}
.accordion .card {border:none;}

/* --- Top Actions Bar --- */
#app-actions-top {
    background-color: #fff;
    padding: 12px 15px;
    margin-bottom: 25px;
    border-radius: 5px;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
}
#app-actions-top .action-group { display: flex; gap: 8px; align-items: center;}
#app-actions-top .form-control-sm { height: calc(1.5em + .5rem + 2px); font-size: 0.875rem;}
#app-actions-top .btn { margin-top: 0; margin-bottom:0; padding: 0.4rem 0.8rem; font-size: 0.875em; display:inline-flex; align-items:center; gap: 5px;}
#new-analysis-button-top { margin-left: auto; background-color: var(--secondary-color); border-color: var(--secondary-color); }
#new-analysis-button-top:hover { background-color: var(--dark-gray); }
button#delete-test-button-top {padding: 8px 10px !important;border: 1px solid #aaa;background: #fff;}


/* --- Form Styles --- */
label { font-weight: 600; margin-bottom: 5px; display: inline-block; color: var(--dark-gray); font-size: 14px; position: relative; }
.form-control { border-radius: 4px; border: 1px solid var(--input-border-color); padding: 8px; font-size: 0.95em; background-color: var(--input-bg); box-sizing: border-box; width: 100%; transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out; box-shadow: none; height: auto; }
.form-control:focus { border-color: var(--primary-color); box-shadow: none; outline: 2px solid rgba(0, 95, 248, 0.3); outline-offset: 1px; }
select.form-control { padding-right: 25px; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3e%3cpath fill='%23343a40' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 8px 10px; appearance: none; }
.form-text.text-muted { font-size: 0.85em; margin-top: 0.3rem; }
.form-text.text-info-custom { font-size: 0.85em; margin-top: 0.3rem; color: var(--info-color); }

hr.custom-separator { border: 0; border-top: 1px solid var(--separator-color); margin: 1.5rem 0; }
input[type=date], input[type=email], input[type=number], input[type=password], input[type=search], input[type=tel], input[type=text], input[type=url], select, textarea {width: 100%;border: 1px solid #bbb;border-radius: 3px;padding: .5rem 1rem;transition: all .3s;}
.form-row>.col, .form-row>[class*=col-] {padding: 0 8px;}
#mde-calc-form .form-group { margin-bottom: 1rem; padding-left:0; padding-right:0; }


/* --- Tooltip Styles --- */
.tooltip-icon { display: inline-block; width: 16px; height: 16px; background-color: #999; color: white; border-radius: 50%; text-align: center; font-size: 11px; line-height: 16px; cursor: help; margin-left: 5px; position: relative; top: -1px; }
.tooltip-icon:hover::after { content: attr(data-tooltip); position: absolute; left: 50%; transform: translateX(-50%); bottom: 125%; background-color: var(--tooltip-bg); color: var(--tooltip-text); padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: normal; width: max-content; max-width: 250px; z-index: 1070; opacity: 1; transition: opacity 0.2s; pointer-events: none; }
.tooltip-icon:hover::before { content: ""; position: absolute; left: 50%; transform: translateX(-50%); bottom: 100%; border-width: 5px; border-style: solid; border-color: var(--tooltip-bg) transparent transparent transparent; z-index: 1071;  }

/* --- Button Styles --- */
.btn { font-family: var(--font-family-base); font-weight: 500; border-radius: 5px; padding: 0.6rem 1.2rem; font-size: 0.9em; margin-top: 10px; margin-right: 5px; transition: all 0.2s ease-in-out; cursor: pointer; border: none; }
.btn-link { padding: 0; color: var(--primary-color); text-decoration: none; background-color: transparent; border: 0; font-size: 0.9em; } .btn-link:hover { color: #004ecc; text-decoration: underline; }
.btn-primary { background-color: var(--primary-color); color: #fff; } .btn-primary:hover { background-color: #004ecc; color: #fff; }
.btn:disabled, .btn.disabled { opacity: 0.6; cursor: not-allowed; background-color: #adb5bd; border-color: #adb5bd; color: #fff; }
#calculateMdeButton:disabled, #calculateMdeButton.disabled { background-color: #adb5bd; } 
#startAnalysisButton:disabled, #startAnalysisButton.disabled { background-color: #adb5bd; }

/* --- Table Styles --- */
table { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
th, td, table thead:first-child tr:first-child th { text-align: center; padding: 8px 10px; vertical-align: middle; border: 1px solid #dee2e6; font-size: 0.9em; }
th { background-color: var(--light-gray); color: var(--dark-gray); font-weight: 600; white-space: nowrap; }
table tbody>tr:nth-child(odd)>td {background-color:hsla(0,0%,50.2%,.0705882353); }
#mde-forecast-table th, #mde-forecast-table td { font-size: 1em; }
#mde-forecast-table td:first-child { text-align: left; padding-left: 15px; }
#mde-forecast-table input[type="radio"] { margin: 0; vertical-align: middle; cursor: pointer; transform: scale(1.1); margin-right: 5px; }
#mde-forecast-table tr.selected-week { background-color: rgba(0, 95, 248, 0.15) !important; font-weight: bold; cursor: default; border-left: 3px solid var(--primary-color); }
#history-table th, #history-table td { font-size: 0.85em; padding: 8px 6px; }
#history-table .variation-label { text-align: center; font-weight: bold; width: 30px;}
#history-table td:first-child { width: 50px; }
#history-table button.btn-sm { padding: 0.2rem 0.4rem; font-size: 0.8em; margin: 0 2px; }
#boundaries-table .current-stage-row { background-color: #e7f3ff; font-weight: bold; }
.table-responsive { border: 1px solid var(--border-color); border-radius: 5px; overflow-x: auto; background: #fff; }

/* AJOUT START: Styles pour tableau gain estimé */
#lift-visualization-table td.gain-positive { background-color: var(--gain-positive-bg); color: var(--gain-positive-text); }
#lift-visualization-table td.gain-negative { background-color: var(--gain-negative-bg); color: var(--gain-negative-text); }
#lift-visualization-table td .arrow-up { color: var(--gain-positive-text); margin-right: 3px;}
#lift-visualization-table td .arrow-down { color: var(--gain-negative-text); margin-right: 3px;}
/* AJOUT END */


/* --- Accordion Styles --- */
.card-header {background-color: #fff !important;border:none !important; padding: 0;padding: .75rem 1.25rem;margin-bottom: 0;border-bottom: 1px solid rgba(0, 0, 0, .125);}
button#mdeAccordionButton {background: #fff;color: #333;font-weight: 600;font-size: 18px;}
.accordion .card-header button.btn-link {color: var(--dark-gray); text-decoration: none; font-weight: 600; font-size: 1.1rem;width: 100%; text-align: left; padding: 15px 20px;
    border: none; background: none; 
    position: relative; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
}
.accordion .card-header button.btn-link:hover {color: var(--primary-color); }
.accordion .card-header button.btn-link:focus { box-shadow: none; outline: none; }
.accordion .card-header button.btn-link::after { 
    content: '❯'; 
    font-family: sans-serif; 
    font-size: 1.2rem;
    line-height: 1;
    font-weight: bold;
    transition: transform 0.2s ease-in-out;
    margin-left: 10px;
}
.accordion .card-header button.btn-link:not(.collapsed)::after { 
    transform: rotate(90deg);
}
.accordion .card-body { padding: 15px 30px; border-top: 1px solid var(--border-color); border-radius: 0; }

/* --- Specific Elements & Utilities --- */
#chart-container { height: 550px; margin-top: 20px; }
#lift-visualization-table { width: 100%; margin-bottom: 10px; }
#lift-visualization-table th, #lift-visualization-table td {padding: 8px;font-size: 0.9em;text-align: center;vertical-align: middle;border: 1px solid #dee2e6;}
#lift-visualization-table th { background-color: var(--light-gray); font-weight: 700; }
#lift-visualization-table th:first-child, #lift-visualization-table td:first-child { width: 20%; font-weight: bold; } 
#lift-visualization-table th:nth-child(2), #lift-visualization-table td:nth-child(2),
#lift-visualization-table th:nth-child(3), #lift-visualization-table td:nth-child(3) { width: 15%; text-align: center;} 
#lift-visualization-table th:nth-child(4), #lift-visualization-table td:nth-child(4) { width: 20%; text-align: center; font-weight: bold;} 
#lift-visualization-table th:nth-child(5), #lift-visualization-table td:nth-child(5) { width: 30%; } 
#lift-visualization-table .lift-chart-cell { height: 30px; padding: 0 !important; }


#loading, #mde-loading { display: none; text-align: center; margin-top: 15px; font-style: italic; color: #555; }
#decision { font-weight: bold; font-size: 1em; padding: 12px 15px; border-radius: 5px; text-align: left; margin-top: 15px; border: 1px solid transparent; }
.decision-continue { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
.decision-stop-win { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
.decision-stop-futility { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
.decision-stop-critical { background-color: var(--danger-color); color: white; border-color: var(--danger-color); } 
.decision-discuss { background-color: var(--discussion-color-bg); color: var(--discussion-color-text); border-color: var(--discussion-color-border); }

#primary-indicator-column-results label, #secondary-indicator-column-results label {margin-top:2px;}
#primary-indicator-column-results p, #secondary-indicator-column-results p {margin-bottom:0rem;}


.error, #mde-error { color: var(--danger-color); font-weight: bold; margin-top: 10px; white-space: pre-wrap; background-color: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;}
.highcharts-tooltip>span { padding: 10px; background: rgba(255, 255, 255, 0.95); border: 1px solid #ccc; border-radius: 4px; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); font-family: var(--font-family-base); font-size: 0.9em; z-index: 1070; }

#mainAccordion .left-column-bg { background-color: #fafafa; padding: 30px 15px !important; border-radius: 3px;  border: 1px solid var(--border-color);}
#mainAccordion .right-column-bg { background-color: var(--right-col-bg); padding: 20px !important; border: 1px solid var(--border-color); border-radius:3px;}

#analysis-experiment-section h5 { font-size: 1.05em; color: #333; margin-bottom: 1.2rem; margin-top: 0.8rem;font-weight: bold;}
#analysis-experiment-section .col-md-6 .lift-display-item { order: -1; }
#analysis-experiment-section .col-md-6 p { margin-bottom: 0rem; font-size: 0.8rem;font-weight: 600;}
#analysis-experiment-section .col-md-6 p label {color: var(--secondary-color);margin-bottom: 3px;font-weight: 500;}
#analysis-experiment-section .col-md-6 p strong { font-size:0.95em; }
#analysis-experiment-section .col-md-6 .variance-display { margin-top: -0.1rem; margin-bottom: 0.7rem; font-size: 0.8em; color: #777; display: inline; }
#analysis-experiment-section .lift-display-item { margin-bottom: 0.8rem;}
#analysis-experiment-section .lift-display-item .lift-label { font-size: 1em; color: var(--secondary-color); font-weight:600;}
#analysis-experiment-section .lift-display-item .liftValueItem { font-size: 1.5rem !important; }
#analysis-experiment-section hr.custom-separator { margin-top:1rem; margin-bottom:1rem;}

#liftVariance { display: none !important; } 

#additional-analysis-metrics {padding: 1.5rem 0;margin-bottom: 1rem;border-bottom: 1px solid #eee;}
#additional-analysis-metrics .metric-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
#additional-analysis-metrics .metric-item { display: flex; align-items: center; font-size: 0.95em; }
#additional-analysis-metrics .metric-item > label { margin-bottom: 0; margin-right: 8px; }
#additional-analysis-metrics .metric-item > strong { color: var(--dark-gray); }
#additional-analysis-metrics .metric-item > .tooltip-icon { margin-left: 8px; }

#srmCheckIndicator.srm-ok { color: var(--srm-ok-color); font-weight: bold; }
#srmCheckIndicator.srm-error { color: var(--srm-error-color); font-weight: bold; }
#testProgressGaugeContainer { width: 100%; height: 20px; margin-top: 5px; max-width:120px;}

#secondary-metric-results { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed var(--border-color); }
#secondary-indicator-column-results #secondary-metric-results { margin-top: 0; padding-top: 0; border-top: none;}
#secondary-metric-results h5 { font-size: 1.05em; color: var(--primary-color); margin-bottom: 0.6rem; margin-top:0.8rem;}
#secondary-metric-results p { margin-bottom: 0.3rem;}
#secondary-metric-results p label { font-weight: 500; color: var(--secondary-color); font-size: 0.9em;}
#secondary-metric-results p strong { font-size:0.95em; }
#secondary-metric-results .variance-display { margin-top: -0.1rem; margin-bottom: 0.7rem; font-size: 0.8em; color: #777; display: inline; }
#secondary-metric-results .bounds-info { font-size: 0.85em; color: #666; margin-top: 5px; }
#secondary-metric-results .bounds-info strong { font-weight: 600; }

#data-entry-section .variation-column-wrapper { margin-bottom: 20px; }
#data-entry-section .variation-column-wrapper:last-child { margin-bottom: 0; }
#data-entry-section .variation-column { border: 1px solid var(--border-color); padding: 20px; border-radius: 5px; background-color: #fff;}
#data-entry-section .variation-column h3 { color: #333 !important; margin-top: 0; margin-bottom: 20px; padding-bottom: 10px; flex-shrink: 0; font-size:1.2rem; border-bottom: 1px solid var(--medium-gray);}
#data-entry-section .variation-column .form-row .form-group { margin-bottom: 1rem;}
#secondary-metric-inputs-a, #secondary-metric-inputs-b { padding-top: 0; }

#step2-title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.2rem; }
#step2-title-container h3 { margin-bottom: 0; }
#step2-title-container a { font-size: 0.9em; }
#data-entry-actions-bottom { display: flex; align-items: center; margin-top: 15px; margin-bottom: 0px;}
#data-entry-actions-bottom .btn { margin-top: 0; margin-right: 15px; }
#data-entry-actions-bottom #loading { margin-left: 15px; }

#toggle-boundaries-table-wrapper {text-align: center; margin-top: 10px; margin-bottom: 15px; font-size: 0.9em;}
.container-fluid { padding-left: 15px; padding-right: 15px; max-width: 1200px; margin: 0 auto;}

.details-toggle-link { font-size: 0.85em; margin-bottom: 0.5rem; display: block; }


  </style>
</head>
<body>
<div class="container-fluid">

  <!-- Barre d'actions en haut -->
  <div id="app-actions-top" class="section">
      <div class="action-group">
          <input type="text" class="form-control form-control-sm" id="test-name-top" placeholder="Nom du Test" style="width: 200px; margin-right:5px;">
          <button type="button" id="save-test-button-top" class="btn btn-sm btn-info">Sauvegarder</button>
      </div>
      <div class="action-group">
          <select id="saved-tests-list-top" class="form-control form-control-sm" style="width: 200px; margin-right:5px;height:33px;padding:3px;"><option value="">-- Charger un test --</option></select>
          <button type="button" id="load-test-button-top" class="btn btn-sm btn-success">Charger</button>
          <button type="button" id="delete-test-button-top" class="btn btn-sm btn-danger">Suppr.</button>
      </div>
      <button type="button" id="new-analysis-button-top" class="btn btn-sm btn-secondary">Nouvelle Analyse</button>
  </div>

  <!-- Accordion pour Planification (Étape 1) -->
  <div class="section" id="mainAccordion">
    <div class="card">
      <div class="card-header" id="headingMDE">
        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseMDE" aria-expanded="true" aria-controls="collapseMDE" id="mdeAccordionButton">
          Étape 1 : Planification du test A/B
        </button>
      </div>
      <div id="collapseMDE" class="collapse show" aria-labelledby="headingMDE" data-parent="#mainAccordion">
        <div class="card-body">
          <div class="row"> 
              <div class="col-md-6 left-column-bg"> 
                  <form id="mde-calc-form">
                      <h4>Trafic et conversions sur le périmètre du test</h4>
                      <div class="form-group">
                          <label for="baselineTraffic">Trafic total hebdomadaire</label>
                          <input type="number" class="form-control" id="baselineTraffic" placeholder="ex: 20000" min="1">
                          <small id="baselineTrafficInfo" class="form-text text-info-custom" style="display: none;"></small>
                      </div>
                      <div class="form-group">
                          <label for="baselineTotalConversions">Conversions hebdomadaires (Obj. principal)</label>
                          <span class="tooltip-icon" data-tooltip="Conversions totales pour l'objectif principal sur une semaine type.">?</span>
                          <input type="number" class="form-control" id="baselineTotalConversions" placeholder="ex: 2000" min="0">
                          <small id="baselineTotalConversionsInfo" class="form-text text-info-custom" style="display: none;"></small>
                      </div>
                      <div class="form-group">
                         <a href="#" id="toggleBaselineSecondaryKpi" class="btn-link" style="font-size:0.9em;">Ajouter un KPI de sécurité</a>
                      </div>
                      <div class="form-group" id="baselineSecondaryKpiGroup" style="display: none;">
                          <label for="baselineTotalConversionsSecondary">Conversions hebdomadaires (Obj. sécurité)</label>
                          <span class="tooltip-icon" data-tooltip="Conversions totales pour l'objectif de sécurité sur une semaine type. Si renseigné, des bornes séquentielles de non-régression seront calculées.">?</span>
                          <input type="number" class="form-control" id="baselineTotalConversionsSecondary" placeholder="ex: 1000" min="0">
                          <small id="baselineTotalConversionsSecondaryInfo" class="form-text text-info-custom" style="display: none;"></small>
                      </div>
                      <hr class="custom-separator">
                      <h4>Options : statistiques</h4>
                       <div class="form-group">
                        <label for="testStartDate">Date de début du test</label>
                        <input type="date" class="form-control" id="testStartDate">
                      </div>
                      <div class="form-group">
                          <label for="mdeConfidence">Confiance</label> 
                          <span class="tooltip-icon" data-tooltip="Probabilité de ne PAS détecter un faux positif (erreur type I). S'applique aux deux objectifs. 95% est courant (α=0.05).">?</span> 
                          <select class="form-control" id="mdeConfidence">
                              <option value="0.20">80%</option>
                              <option value="0.15">85%</option> 
                              <option value="0.10">90%</option>
                              <option value="0.05" selected>95%</option>
                              <option value="0.01">99%</option>
                          </select> 
                      </div>
                      <div class="form-group">
                          <label for="mdePower">Puissance</label> 
                          <span class="tooltip-icon" data-tooltip="Probabilité de détecter un effet réel s'il existe. S'applique aux deux objectifs. 80% est courant (β=0.20).">?</span> 
                          <select class="form-control" id="mdePower">
                            <option value="0.60">60%</option>
                            <option value="0.65">65%</option>
                            <option value="0.70">70%</option>
                            <option value="0.75">75%</option>
                            <option value="0.80" selected>80%</option>
                            <option value="0.85">85%</option>
                            <option value="0.90">90%</option>
                            <option value="0.95">95%</option>
                          </select> 
                      </div>
                      <div class="form-group">
                           <label for="mdeTestType">Type de Test</label> 
                           <span class="tooltip-icon" data-tooltip="Supériorité: B doit être meilleur que A. Non-régression: B ne doit pas être significativement moins bon que A. S'applique à l'objectif principal. L'objectif de sécurité utilise un test de non-régression par défaut.">?</span> 
                           <select class="form-control" id="mdeTestType"><option value="1">Supériorité</option><option value="3" selected>Non-régression</option></select> 
                      </div>
                      <div class="form-group" style="display: none;"> 
                          <label for="designSpendingFunction">Fonction Dépense (Efficacité)</label> 
                          <select class="form-control" id="designSpendingFunction"><option value="KimDeMets" selected>Kim-DeMets (rho=3)</option><option value="OF">O'Brien-Fleming</option><option value="Pocock">Pocock</option></select> 
                      </div> 
                      <div class="form-group" style="display: none;"> 
                          <label for="designSpendingFunctionLower">Fonction Dépense (Futilité)</label> 
                          <select class="form-control" id="designSpendingFunctionLower"><option value="HSD" selected>HSD (gamma=-2)</option><option value="KimDeMets">Kim-DeMets (rho=3)</option><option value="OF">O'Brien-Fleming</option><option value="Pocock">Pocock</option></select> 
                      </div>
                      <input type="number" class="form-control" id="designK" style="display:none;">
                      <hr class="custom-separator">
                      <button type="button" id="calculateMdeButton" class="btn btn-info" style="display: none;">Estimer la durée / MDE</button>
                      <div id="mde-loading">Calcul en cours...</div> <div id="mde-error" class="error" style="display: none;"></div>
                      <div style="display: none;"> <input id="designAlpha"> <input id="designBeta"> <input id="designTestTypeHidden"> </div>
                      <input type="hidden" id="apiUrl" value="https://my-gst-api.onrender.com/api/calculate-boundaries">
                  </form>
              </div>
              <div class="col-md-6 right-column-bg"> 
                  <div id="mde-forecast-results" style="margin-top: 0; display: none;">
                      <h3>Sélectionnez la durée du test</h3>
                      <p style="font-size: 0.9em;">Cliquez sur une ligne pour choisir la durée maximale (K) de votre test. Les bornes séquentielles seront calculées pour les objectifs configurés.</p>
                      <div class="table-responsive">
                          <table class="table table-bordered table-hover table-sm" id="mde-forecast-table">
                              <thead>
                                  <tr>
                                      <th>Durée max</th>
                                      <th>MDE Obj. principal</th>
                                      <th id="mdeTableSecondaryColHeader" style="display:none;">MDE Obj. sécurité</th>
                                  </tr>
                              </thead>
                              <tbody id="mde-forecast-tbody"></tbody>
                          </table>
                      </div>
                  </div>
                  <button type="button" id="startAnalysisButton" class="btn btn-success" style="margin-top: 20px;" disabled>Valider la durée & Calculer Bornes Initiales</button>
                  <small class="form-text text-muted" id="start-analysis-help"></small>
              </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Étape 2 : Saisie des Données -->
  <div class="section" id="data-entry-section" style="display:none;">
      <div id="step2-title-container">
          <h3 id="data-entry-title">Étape 2 : Saisie des Données</h3> 
          <a href="#" id="toggle-history-table" class="btn-link">Modifier l'historique des données</a>
      </div>
      <p class="text-muted" style="font-size:0.9em; margin-top: -0.5em; margin-bottom: 1.5em;">
          Entrez les données cumulées pour chaque variation. L'historique est modifiable via le lien ci-dessus.
      </p>

      <form id="data-form">
           <!-- Variation A -->
           <div class="variation-column-wrapper">
              <div class="variation-column">
                  <h3>Variation A</h3>
                  <div class="form-row">
                      <div class="form-group col-md-4">
                          <label for="controlVisitors">Visiteurs</label>
                          <span class="tooltip-icon" data-tooltip="Total visiteurs pour A depuis le début.">?</span>
                          <input type="number" class="form-control" id="controlVisitors" placeholder="ex: 100000" min="0">
                      </div>
                      <div class="form-group col-md-4">
                          <label for="controlConversions">Obj. principal</label>
                          <span class="tooltip-icon" data-tooltip="Total conversions (Principal) pour A.">?</span>
                          <input type="number" class="form-control" id="controlConversions" placeholder="ex: 10000" min="0">
                      </div>
                      <div id="secondary-metric-inputs-a" class="form-group col-md-4" style="display: none;">
                          <label for="controlConversionsSecondary">Obj. sécurité</label>
                          <span class="tooltip-icon" data-tooltip="Total conversions (Secondaire) pour A.">?</span>
                          <input type="number" class="form-control" id="controlConversionsSecondary" placeholder="ex: 5000" min="0">
                      </div>
                  </div>
              </div>
          </div>

          <!-- Variation B -->
          <div class="variation-column-wrapper">
              <div class="variation-column">
                  <h3>Variation B</h3>
                  <div class="form-row">
                      <div class="form-group col-md-4">
                          <label for="variantVisitors">Visiteurs</label>
                          <span class="tooltip-icon" data-tooltip="Total visiteurs pour B depuis le début.">?</span>
                          <input type="number" class="form-control" id="variantVisitors" placeholder="ex: 100000" min="0">
                      </div>
                      <div class="form-group col-md-4">
                          <label for="variantConversions">Obj. principal</label>
                          <span class="tooltip-icon" data-tooltip="Total conversions (Principal) pour B.">?</span>
                          <input type="number" class="form-control" id="variantConversions" placeholder="ex: 10500" min="0">
                      </div>
                      <div id="secondary-metric-inputs-b" class="form-group col-md-4" style="display: none;">
                          <label for="variantConversionsSecondary">Obj. sécurité</label>
                          <span class="tooltip-icon" data-tooltip="Total conversions (Secondaire) pour B.">?</span>
                          <input type="number" class="form-control" id="variantConversionsSecondary" placeholder="ex: 4950" min="0">
                      </div>
                  </div>
              </div>
          </div>

          <div id="data-entry-actions-bottom">
              <button type="button" id="addDataButton" class="btn btn-primary">Ajouter les données</button>
              <div id="loading" style="display: none;">Analyse en cours...</div>
          </div>
      </form>
  </div><!-- Fin #data-entry-section -->

  <!-- Tableau Historique -->
  <div class="section" id="history-section" style="display:none;">
      <h3>Historique Hebdomadaire (Calculé)</h3>
      <p style="font-size: 0.9em; color: #666;">Ce tableau montre les données *incrémentales* calculées pour chaque semaine.</p>
      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm" id="history-table">
           <thead>
             <tr>
                <th rowspan="2" style="vertical-align: middle;">Sem.</th> <th rowspan="2" style="vertical-align: middle;">Var.</th> <th rowspan="1" colspan="1">Trafic</th> <th colspan="2">Objectif Principal (Hebdo)</th> <th colspan="2" id="historyTableSecondaryHeaderGroup" style="display: none;">Objectif Sécurité (Hebdo)</th> <th rowspan="2" style="vertical-align: middle;">Actions</th>
             </tr>
              <tr>
                 <th>Visiteurs</th> <th>Conv.</th><th>Taux (%)</th> <th id="historyTableSecondaryConvHeader" style="display: none;">Conv.</th><th id="historyTableSecondaryRateHeader" style="display: none;">Taux (%)</th>
              </tr>
           </thead>
          <tbody id="history-tbody"></tbody>
        </table>
      </div>
      <div id="srm-warning" class="alert alert-warning" role="alert" style="display:none;"> <strong>Attention SRM :</strong> Répartition trafic cumulée (objectif principal) inégale détectée (p < 0.05). </div>
  </div><!-- Fin #history-section -->


  <!-- Étape 3 : Résultats -->
  <div class="section" id="results" style="display:none;">
      
      
      <div id="additional-analysis-metrics">
          <div class="metric-row">
            <div class="col-md-3"><h3>Étape 3 : Résultats (<span id="resultStage"></span> / <span id="totalStages"></span>)</h3></div>
              <div class="metric-item col-md-5">
                  <label>Progression :</label>
                  <div id="testProgressGaugeContainer"></div>
                  <strong id="testProgressPercentage" style="margin-left: 10px;">N/A</strong>
              </div>
              <div class="metric-item col-md-5">
                  <label>Répartition du trafic :</label> <strong id="srmCheckIndicator">N/A</strong>
                  <span class="tooltip-icon" data-tooltip="SRM (Sample Ratio Mismatch) indique un déséquilibre inattendu dans la répartition du trafic. Vérifiez votre système de tracking.">?</span>
              </div>
          </div>
      </div>
      <div id="projectedGainDisplay" style="display: none; margin-bottom:15px; text-align:center; font-weight:500;"></div>

      
      <div id="analysis-experiment-section">
          <div class="row">
              <div id="decision" class="alert col-md-4"></div>

              <div class="col-md-4" id="primary-indicator-column-results">
                  <h3>Objectif Principal</h3>
                   <div id="lift-display" class="lift-display-item">
                      <span class="lift-label">Gain estimé:</span>
                      <strong id="liftValue" class="liftValueItem">N/A</strong>
                  </div>
                  <p><label>Conv. A:</label> <span id="crControl"></span> <small class="variance-display" id="crControlVariance"></small></p>
                  <p><label>Conv. B:</label> <span id="crVariant"></span> <small class="variance-display" id="crVariantVariance"></small></p>
                  
                  <a href="#" id="togglePrincipalDetailsLink" class="btn-link details-toggle-link">Voir plus de détails</a>
                  <div id="principalDetailsContainer" style="display: none;">
                      <p><label>Z-score Cumulé:</label> <span id="zScorePrincipal">N/A</span></p>
                      <p class="bounds-info">
                          <label>Bornes Z:</label>
                          Sup (<span id="upperBoundTypePrincipal"></span>): <span id="effBoundaryDisplayPrincipal">N/A</span> |
                          Inf (<span id="lowerBoundTypePrincipal"></span>): <span id="futBoundaryDisplayPrincipal">N/A</span>
                      </p>
                  </div>
              </div>
              <div class="col-md-4" id="secondary-indicator-column-results">
                  <div id="secondary-metric-results" style="display: none;">
                      <h3>Objectif Sécurité</h3>
                       <div id="lift-display-secondary" class="lift-display-item">
                            <span class="lift-label">Gain estimé:</span>
                            <strong id="liftValueSecondary" class="liftValueItem">N/A</strong>
                       </div>
                       <p><label>Conv. A:</label> <span id="crControlSecondary"></span> <small class="variance-display" id="crControlSecondaryVariance"></small></p>
                       <p><label>Conv. B:</label> <span id="crVariantSecondary"></span> <small class="variance-display" id="crVariantSecondaryVariance"></small></p>
                       
                       <a href="#" id="toggleSecondaryDetailsLink" class="btn-link details-toggle-link">Voir plus de détails</a>
                       <div id="secondaryDetailsContainer" style="display: none;">
                           <p><label>Z-score Cumulé:</label> <span id="zScoreSecondary">N/A</span></p>
                           <p class="bounds-info">
                               <label>Bornes Z:</label>
                               Non-Rég.: <span id="effBoundaryDisplaySecondary">N/A</span> |
                               Régression: <span id="futBoundaryDisplaySecondary">N/A</span>
                           </p>
                       </div>
                  </div>
              </div>
          </div>
      </div>
      <hr class="custom-separator">

      <h4>Gain estimé (Visualisation)</h4>
      <div id="lift-visualization-table-wrapper" class="table-responsive">
          <table id="lift-visualization-table" class="table table-sm">
              <thead>
                  <tr>
                      <th>Objectif</th>
                      <th>CR (A) %</th>
                      <th>CR (B) %</th>
                      <th>Gain Estimé (%)</th>
                      <th>Visualisation (IC 95%)</th>
                  </tr>
              </thead>
              <tbody id="lift-visualization-tbody"></tbody>
          </table>
      </div>

      <div id="error" class="error" style="display: none;"></div>
      <div id="chart-container"></div>
       <div id="toggle-boundaries-table-wrapper"> <a href="#" id="toggle-boundaries-table" class="btn-link">Voir les bornes séquentielles (Obj. Principal)</a> </div>
      <div class="table-responsive" id="boundaries-table-container" style="display: none;">
          <h4 style="margin-top: 25px;">Bornes Séquentielles (Objectif Principal)</h4>
          <table class="table table-bordered table-sm" id="boundaries-table"> <thead> <tr><th>Étape</th><th>Info. Frac.</th><th id="upperBoundLabelPrincipalTable">Z Borne Sup</th><th id="lowerBoundLabelPrincipalTable">Z Borne Inf</th></tr> </thead> <tbody id="boundaries-tbody"></tbody> </table>
      </div>
  </div><!-- Fin #results -->

</div> <!-- Fin .container-fluid -->

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <script>
    const STORAGE_PREFIX = "gstSequentialAnalysis_v321_"; // Version up

    document.addEventListener('DOMContentLoaded', function() {
        // --- Sélecteurs DOM (Principaux) ---
        const testNameTopInput = document.getElementById('test-name-top');
        const saveTestButtonTop = document.getElementById('save-test-button-top');
        const savedTestsListTop = document.getElementById('saved-tests-list-top');
        const loadTestButtonTop = document.getElementById('load-test-button-top');
        const deleteTestButtonTop = document.getElementById('delete-test-button-top');
        const newAnalysisButtonTop = document.getElementById('new-analysis-button-top');

        // --- Sélecteurs DOM (Étape 1 - Planification) ---
        const mdeCalcForm = document.getElementById('mde-calc-form');
        const baselineTrafficInput = document.getElementById('baselineTraffic');
        const baselineTotalConversionsInput = document.getElementById('baselineTotalConversions');
        const baselineTotalConversionsSecondaryInput = document.getElementById('baselineTotalConversionsSecondary');
        const baselineSecondaryKpiGroup = document.getElementById('baselineSecondaryKpiGroup'); 
        const toggleBaselineSecondaryKpiLink = document.getElementById('toggleBaselineSecondaryKpi'); 
        const testStartDateInput = document.getElementById('testStartDate'); // AJOUT
        const mdeConfidenceSelect = document.getElementById('mdeConfidence');
        const mdePowerSelect = document.getElementById('mdePower');
        const mdeTestTypeSelect = document.getElementById('mdeTestType'); 
        const designSpendingFunctionSelect = document.getElementById('designSpendingFunction');
        const designSpendingFunctionLowerSelect = document.getElementById('designSpendingFunctionLower');
        const designKInput = document.getElementById('designK'); 
        const calculateMdeButton = document.getElementById('calculateMdeButton');
        const mdeLoadingDiv = document.getElementById('mde-loading');
        const mdeErrorDiv = document.getElementById('mde-error');
        const mdeResultsDiv = document.getElementById('mde-forecast-results');
        const mdeForecastTbody = document.getElementById('mde-forecast-tbody');
        const mdeTableSecondaryColHeader = document.getElementById('mdeTableSecondaryColHeader'); 
        const startAnalysisButton = document.getElementById('startAnalysisButton');
        const startAnalysisHelpText = document.getElementById('start-analysis-help');
        const mdeAccordionButton = document.getElementById('mdeAccordionButton');
        const collapseMDE = document.getElementById('collapseMDE');
        const apiUrlInput = document.getElementById('apiUrl');
        const baselineTrafficInfo = document.getElementById('baselineTrafficInfo');
        const baselineTotalConversionsInfo = document.getElementById('baselineTotalConversionsInfo');
        const baselineTotalConversionsSecondaryInfo = document.getElementById('baselineTotalConversionsSecondaryInfo');


        // --- Sélecteurs DOM (Étape 2 - Saisie Données) ---
        const dataEntrySection = document.getElementById('data-entry-section');
        const dataForm = document.getElementById('data-form');
        const controlVisitorsInput = document.getElementById('controlVisitors');
        const controlConversionsInput = document.getElementById('controlConversions');
        const variantVisitorsInput = document.getElementById('variantVisitors');
        const variantConversionsInput = document.getElementById('variantConversions');
        const controlConversionsSecondaryInput = document.getElementById('controlConversionsSecondary');
        const variantConversionsSecondaryInput = document.getElementById('variantConversionsSecondary');
        const secondaryMetricInputsA = document.getElementById('secondary-metric-inputs-a');
        const secondaryMetricInputsB = document.getElementById('secondary-metric-inputs-b');
        const addDataButton = document.getElementById('addDataButton');
        const dataEntryTitle = document.getElementById('data-entry-title');
        const loadingDiv = document.getElementById('loading'); 

        // --- Sélecteurs DOM (Historique) ---
        const historySection = document.getElementById('history-section');
        const historyTbody = document.getElementById('history-tbody');
        const toggleHistoryTableLink = document.getElementById('toggle-history-table');
        const srmWarningDiv = document.getElementById('srm-warning');
        const historyTableSecondaryHeaderGroup = document.getElementById('historyTableSecondaryHeaderGroup');
        const historyTableSecondaryConvHeader = document.getElementById('historyTableSecondaryConvHeader');
        const historyTableSecondaryRateHeader = document.getElementById('historyTableSecondaryRateHeader');
        
        // --- Sélecteurs DOM (Étape 3 - Résultats) ---
        const resultsDiv = document.getElementById('results');
        const decisionDiv = document.getElementById('decision');
        const resultStageSpan = document.getElementById('resultStage');
        const totalStagesSpan = document.getElementById('totalStages');
        const errorDivGen = document.getElementById('error'); 

        const testProgressPercentageSpan = document.getElementById('testProgressPercentage');
        const testProgressGaugeContainer = document.getElementById('testProgressGaugeContainer');
        const srmCheckIndicator = document.getElementById('srmCheckIndicator');
        const projectedGainDisplay = document.getElementById('projectedGainDisplay');

        const crControlDisplay = document.getElementById('crControl');
        const crVariantDisplay = document.getElementById('crVariant');
        const crControlVarianceElement = document.getElementById('crControlVariance');
        const crVariantVarianceElement = document.getElementById('crVariantVariance');
        const liftValueElement = document.getElementById('liftValue');
        const zScorePrincipalDisplay = document.getElementById('zScorePrincipal'); 
        const upperBoundTypePrincipalSpan = document.getElementById('upperBoundTypePrincipal'); 
        const effBoundaryDisplayPrincipal = document.getElementById('effBoundaryDisplayPrincipal'); 
        const lowerBoundTypePrincipalSpan = document.getElementById('lowerBoundTypePrincipal'); 
        const futBoundaryDisplayPrincipal = document.getElementById('futBoundaryDisplayPrincipal'); 
        
        const secondaryMetricResultsDiv = document.getElementById('secondary-metric-results');
        const crControlSecondaryDisplay = document.getElementById('crControlSecondary');
        const crVariantSecondaryDisplay = document.getElementById('crVariantSecondary');
        const crControlSecondaryVarianceElement = document.getElementById('crControlSecondaryVariance');
        const crVariantSecondaryVarianceElement = document.getElementById('crVariantSecondaryVariance');
        const liftValueSecondaryElement = document.getElementById('liftValueSecondary');
        const zScoreSecondaryDisplay = document.getElementById('zScoreSecondary'); 
        const effBoundaryDisplaySecondary = document.getElementById('effBoundaryDisplaySecondary'); 
        const futBoundaryDisplaySecondary = document.getElementById('futBoundaryDisplaySecondary'); 

        const liftVisualizationTbody = document.getElementById('lift-visualization-tbody');

        const chartContainer = document.getElementById('chart-container'); 
        const boundariesTableContainer = document.getElementById('boundaries-table-container');
        const toggleBoundariesTableLink = document.getElementById('toggle-boundaries-table');
        const boundariesTbody = document.getElementById('boundaries-tbody'); 
        const upperBoundLabelPrincipalTableTh = document.getElementById('upperBoundLabelPrincipalTable'); 
        const lowerBoundLabelPrincipalTableTh = document.getElementById('lowerBoundLabelPrincipalTable'); 
        
        const togglePrincipalDetailsLink = document.getElementById('togglePrincipalDetailsLink');
        const principalDetailsContainer = document.getElementById('principalDetailsContainer');
        const toggleSecondaryDetailsLink = document.getElementById('toggleSecondaryDetailsLink');
        const secondaryDetailsContainer = document.getElementById('secondaryDetailsContainer');


        // --- Variables Globales ---
        let currentDesignParams = null; 
        let currentBoundariesApiResultPrincipal = null;
        let currentBoundariesApiResultSecondary = null; 
        let weeklyEnteredData = [];
        let chartInstance = null; 
        let liftChartInstances = {};
        let progressGaugeInstance = null;
        let observedZDataPrincipal = []; 
        let observedZDataSecondary = []; 
        let isSecondaryKpiPlanned = false; 

        // --- Constantes ---
        const TEST_TYPE_SECONDARY_DEFAULT = 3; 
        const INDICATOR_STATE = {
            POSITIVE: 'POSITIVE',
            NEGATIVE: 'NEGATIVE',
            NEUTRAL: 'NEUTRAL', 
            RISK_NEGATIVE: 'RISK_NEGATIVE' 
        };


        // --- Initialisation et Écouteurs ---
        saveTestButtonTop.addEventListener("click", saveCurrentTestState);
        loadTestButtonTop.addEventListener("click", loadSelectedTestState);
        deleteTestButtonTop.addEventListener("click", deleteSelectedTestState);
        newAnalysisButtonTop.addEventListener("click", () => { if (confirm("Réinitialiser complètement l'analyse ?")) resetFullAnalysis(false); }); 
        
        startAnalysisButton.addEventListener('click', initializeDesignAndBoundaries);
        addDataButton.addEventListener('click', handleAddOrUpdateCumulativeData);
        
        [baselineTrafficInput, baselineTotalConversionsInput, baselineTotalConversionsSecondaryInput, mdeConfidenceSelect, mdePowerSelect, mdeTestTypeSelect, testStartDateInput].forEach(el => {
            if (el) {
                const eventType = (el.tagName.toLowerCase() === 'select' || el.type === 'date') ? 'change' : 'input';
                el.addEventListener(eventType, () => {
                    if (el.id === 'testStartDate') { // Seulement mettre à jour le titre si la date change
                        if (currentDesignParams) currentDesignParams.testStartDate = testStartDateInput.value; // Mettre à jour la date dans les params
                        updateDataEntryTitle(); 
                    } else { // Pour les autres champs, recalculer MDE
                        calculateAndDisplayMDEForecast();
                    }
                });
            }
        });
        
        toggleBaselineSecondaryKpiLink.addEventListener('click', toggleBaselineSecondaryKpiField); 
        toggleHistoryTableLink.addEventListener('click', toggleHistoryTable);
        toggleBoundariesTableLink.addEventListener('click', toggleBoundariesTable); 
        
        mdeForecastTbody.addEventListener('click', handleMdeRowClick);
        designKInput.addEventListener('input', handleKInputChange); 
        
        if (togglePrincipalDetailsLink && principalDetailsContainer) {
            togglePrincipalDetailsLink.addEventListener('click', function(e) {
                e.preventDefault();
                const isHidden = principalDetailsContainer.style.display === 'none';
                principalDetailsContainer.style.display = isHidden ? 'block' : 'none';
                togglePrincipalDetailsLink.textContent = isHidden ? 'Masquer les détails' : 'Voir plus de détails';
            });
        }
        if (toggleSecondaryDetailsLink && secondaryDetailsContainer) {
            toggleSecondaryDetailsLink.addEventListener('click', function(e) {
                e.preventDefault();
                const isHidden = secondaryDetailsContainer.style.display === 'none';
                secondaryDetailsContainer.style.display = isHidden ? 'block' : 'none';
                toggleSecondaryDetailsLink.textContent = isHidden ? 'Masquer les détails' : 'Voir plus de détails';
            });
        }
        
        function formatDate(dateObj) {
            if (!dateObj || !(dateObj instanceof Date) || isNaN(dateObj)) return 'JJ/MM/AAAA';
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0'); 
            const year = dateObj.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // MODIFICATION START: Logique du titre de l'Étape 2
        function updateDataEntryTitle() {
            if (!currentDesignParams || !currentDesignParams.testStartDate) {
                dataEntryTitle.textContent = 'Étape 2 : Saisie des Données';
                return;
            }
            // Utiliser la date de début du test stockée dans currentDesignParams
            const testStartDateObj = new Date(currentDesignParams.testStartDate + 'T00:00:00'); 
            if (isNaN(testStartDateObj)) {
                 dataEntryTitle.textContent = 'Étape 2 : Saisie des Données (Date de début invalide)';
                 return;
            }

            const currentWeekNumber = weeklyEnteredData.length + 1; // La semaine pour laquelle on va entrer des données
            
            // La date de début de la période de saisie est toujours la date de début du test
            const displayStartDateFormatted = formatDate(testStartDateObj);

            // Calculer la date de fin de la période de la semaine en cours de saisie
            let periodEndDate = new Date(testStartDateObj);
            periodEndDate.setDate(testStartDateObj.getDate() + (currentWeekNumber * 7) - 1); // Fin de la semaine X

            if (currentWeekNumber <= currentDesignParams.k) {
                 dataEntryTitle.textContent = `Étape 2 : Saisie des données du ${displayStartDateFormatted} au ${formatDate(periodEndDate)} (Semaine ${currentWeekNumber})`;
            } else {
                 dataEntryTitle.textContent = 'Étape 2 : Saisie des Données (Test terminé)';
            }
        }
        // MODIFICATION END


        // --- Fonctions MDE Calculator (Étape 1) ---
        function toggleBaselineSecondaryKpiField(event) {
            event.preventDefault();
            const isHidden = baselineSecondaryKpiGroup.style.display === 'none';
            baselineSecondaryKpiGroup.style.display = isHidden ? 'block' : 'none';
            toggleBaselineSecondaryKpiLink.textContent = isHidden ? 'Retirer le KPI de sécurité (planification)' : 'Ajouter un KPI de sécurité (planification)';
            isSecondaryKpiPlanned = isHidden; 
            
            if (!isHidden) {
                baselineTotalConversionsSecondaryInput.value = '';
            }
            calculateAndDisplayMDEForecast(); 
        }

        function calculateAndDisplayMDEForecast() {
            baselineTrafficInfo.style.display = 'none'; baselineTrafficInfo.textContent = '';
            baselineTotalConversionsInfo.style.display = 'none'; baselineTotalConversionsInfo.textContent = '';
            if (baselineTotalConversionsSecondaryInfo) { 
                baselineTotalConversionsSecondaryInfo.style.display = 'none'; baselineTotalConversionsSecondaryInfo.textContent = '';
            }
            mdeErrorDiv.textContent = ''; mdeErrorDiv.style.display = 'none';

            const baseTrafficStr = baselineTrafficInput.value.trim();
            const baseConvsPrimaryStr = baselineTotalConversionsInput.value.trim();
            const baseConvsSecondaryStr = isSecondaryKpiPlanned ? baselineTotalConversionsSecondaryInput.value.trim() : '';

            if (!baseTrafficStr && !baseConvsPrimaryStr) {
                mdeForecastTbody.innerHTML = '';
                mdeResultsDiv.style.display = 'none';
                startAnalysisButton.disabled = true;
                return; 
            }

            let canProceedWithCalculation = true;

            if (!baseTrafficStr) {
                baselineTrafficInfo.textContent = "Veuillez renseigner le trafic hebdomadaire.";
                baselineTrafficInfo.style.display = 'block';
                canProceedWithCalculation = false;
            }
            if (!baseConvsPrimaryStr) {
                baselineTotalConversionsInfo.textContent = "Veuillez renseigner les conversions principales.";
                baselineTotalConversionsInfo.style.display = 'block';
                canProceedWithCalculation = false;
            }

            if (isSecondaryKpiPlanned && !baseConvsSecondaryStr && baseTrafficStr && baseConvsPrimaryStr) {
                if (baselineTotalConversionsSecondaryInfo) {
                    baselineTotalConversionsSecondaryInfo.textContent = "KPI sécurité activé, conversions de sécurité non renseignées (optionnel pour MDE principal).";
                    baselineTotalConversionsSecondaryInfo.style.display = 'block';
                }
            }

            if (!canProceedWithCalculation) {
                mdeForecastTbody.innerHTML = '';
                mdeResultsDiv.style.display = 'none';
                startAnalysisButton.disabled = true;
                return;
            }

            mdeLoadingDiv.style.display = 'block'; 
            startAnalysisButton.disabled = true;

            setTimeout(() => {
                try {
                    const baseTraffic = parseInt(baseTrafficStr); 
                    const baseConvsPrimary = parseInt(baseConvsPrimaryStr); 
                    
                    let baseConvsSecondary = null;
                    if (isSecondaryKpiPlanned && baseConvsSecondaryStr) {
                         baseConvsSecondary = parseInt(baseConvsSecondaryStr);
                    }

                    const alpha = parseFloat(mdeConfidenceSelect.value);
                    const power = parseFloat(mdePowerSelect.value);
                    const beta = 1.0 - power;
                    const testTypePrincipal = parseInt(mdeTestTypeSelect.value);

                    if (isNaN(baseTraffic) || baseTraffic <= 0) throw new Error("Trafic hebdo. doit être un nombre > 0.");
                    if (isNaN(baseConvsPrimary) || baseConvsPrimary < 0) throw new Error("Conversions hebdo. (Obj. principal) doivent être un nombre >= 0.");
                    if (baseConvsPrimary > baseTraffic) throw new Error("Conversions (Obj. principal) > Trafic ?");
                    
                    if (isSecondaryKpiPlanned) {
                        if (baseConvsSecondaryStr && (isNaN(baseConvsSecondary) || baseConvsSecondary < 0)) {
                             throw new Error("Conversions hebdo. (Obj. sécurité) invalides si renseignées.");
                        }
                        if (baseConvsSecondary !== null && baseConvsSecondary > baseTraffic) {
                             throw new Error("Conversions (Obj. sécurité) > Trafic ?");
                        }
                    }

                    if (isNaN(alpha) || isNaN(beta)) throw new Error("Confiance/Puissance invalides.");

                    const p1_primary = baseTraffic > 0 ? baseConvsPrimary / baseTraffic : 0;
                    if (p1_primary < 0 || p1_primary >= 1) throw new Error("Taux conv. baseline (Obj. principal) invalide (doit être >=0 et <1).");
                     if (baseTraffic > 0 && baseConvsPrimary > 0 && (p1_primary === 0 || p1_primary === 1) ) { 
                         throw new Error("Taux conv. baseline (Obj. principal) ne peut être 0% ou 100% si trafic et conversions > 0.");
                    }
                    
                    let p1_secondary = null;
                    if (isSecondaryKpiPlanned && baseConvsSecondary !== null && baseTraffic > 0) { 
                        p1_secondary = baseConvsSecondary / baseTraffic;
                        if (p1_secondary < 0 || p1_secondary >= 1) { 
                             console.warn("Taux conv. baseline (Obj. sécurité) invalide (doit être >=0 et <1), MDE non calculé pour le secondaire.");
                             p1_secondary = null; 
                        }
                    }
                    mdeTableSecondaryColHeader.style.display = isSecondaryKpiPlanned ? 'table-cell' : 'none';

                    const zBeta = jStat.normal.inv(power, 0, 1);
                    const zAlpha_principal = (testTypePrincipal === 1 || testTypePrincipal === 3) ? jStat.normal.inv(1 - alpha, 0, 1) : jStat.normal.inv(1 - alpha / 2, 0, 1); 
                    const zAlpha_secondary = jStat.normal.inv(1 - alpha, 0, 1); 

                    let resultsHtml = '';
                    const maxWeeks = 16;
                    for (let w = 1; w <= maxWeeks; w++) {
                        const nPerGroup = (baseTraffic * w) / 2;
                        if (nPerGroup <= 0) continue;
                        
                        const weekText = w > 1 ? 'semaines' : 'semaine';

                        if (p1_primary === 0 && baseConvsPrimary === 0) { 
                             const mde_abs_primary_for_zero_baseline = (zAlpha_principal + zBeta) * Math.sqrt(2 * (0.01 * 0.99) / nPerGroup); 
                             resultsHtml += `<tr data-week="${w}" data-mde-primary="">
                                          <td><input type="radio" name="mdeWeekSelection" value="${w}" id="mde_week_${w}" class="mde-select-radio"><label for="mde_week_${w}" style="margin-bottom: 0; display: inline; cursor: pointer;"><strong>${w}</strong> ${weekText}</label></td>
                                          <td>Baseline 0% (MDE pour ~1% abs: ${(mde_abs_primary_for_zero_baseline*100).toFixed(2)}%)</td>
                                          ${isSecondaryKpiPlanned ? '<td>N/A (Principal à 0%)</td>' : '<td style="display:none;">N/A</td>'}
                                      </tr>`;
                             continue; 
                        }

                        const variancePooled_primary = p1_primary * (1 - p1_primary);
                        const standardErrorDiff_primary = Math.sqrt(2 * variancePooled_primary / nPerGroup);
                        const delta_primary = (zAlpha_principal + zBeta) * standardErrorDiff_primary;
                        const mdeRelative_primary = (p1_primary > 0 && variancePooled_primary > 0 && standardErrorDiff_primary > 0) ? (delta_primary / p1_primary) * 100 : Infinity;

                        let mdeRelative_secondary_display = 'N/A';
                        if (isSecondaryKpiPlanned && p1_secondary !== null && p1_secondary >= 0 && p1_secondary < 1) { 
                            if (p1_secondary === 0) {
                                mdeRelative_secondary_display = 'Baseline 0%';
                            } else {
                                const variancePooled_secondary = p1_secondary * (1 - p1_secondary);
                                if (variancePooled_secondary > 0) {
                                    const standardErrorDiff_secondary = Math.sqrt(2 * variancePooled_secondary / nPerGroup);
                                    if (standardErrorDiff_secondary > 0) {
                                        const delta_secondary = (zAlpha_secondary + zBeta) * standardErrorDiff_secondary; 
                                        const mde_secondary_abs = (delta_secondary / p1_secondary) * 100;
                                        mdeRelative_secondary_display = isFinite(mde_secondary_abs) ? mde_secondary_abs.toFixed(2) + '%' : 'N/A';
                                    }
                                }
                            }
                        } else if (isSecondaryKpiPlanned && p1_secondary === null && baseConvsSecondaryStr) { 
                            mdeRelative_secondary_display = 'Inv. Baseline Sec.';
                        }

                        let secondaryCellHtml = isSecondaryKpiPlanned ? `<td>${mdeRelative_secondary_display}</td>` : `<td style="display:none;">N/A</td>`;
                        
                        resultsHtml += `<tr data-week="${w}" data-mde-primary="${isFinite(mdeRelative_primary) ? mdeRelative_primary.toFixed(4) : ''}">
                                          <td><input type="radio" name="mdeWeekSelection" value="${w}" id="mde_week_${w}" class="mde-select-radio"><label for="mde_week_${w}" style="margin-bottom: 0; display: inline; cursor: pointer;"><strong>${w}</strong> ${weekText}</label></td>
                                          <td>${isFinite(mdeRelative_primary) ? mdeRelative_primary.toFixed(2) + '%' : 'N/A'}</td>
                                          ${secondaryCellHtml}
                                      </tr>`;
                    }
                    if (resultsHtml.length === 0 && !(p1_primary === 0 && baseConvsPrimary === 0) ) { throw new Error("Impossible de calculer le MDE pour l'objectif principal (vérifiez les entrées numériques)."); }

                    mdeForecastTbody.innerHTML = resultsHtml;
                    mdeResultsDiv.style.display = 'block'; 
                    applyKHighlight(designKInput.value); 
                    checkIfStartAnalysisCanBeEnabled();
                } catch (error) {
                    mdeErrorDiv.textContent = `Erreur: ${error.message}`; 
                    mdeErrorDiv.style.display = 'block';
                    mdeResultsDiv.style.display = 'none'; 
                    startAnalysisButton.disabled = true; 
                } finally {
                    mdeLoadingDiv.style.display = 'none';
                }
            }, 100);
        }
        function handleMdeRowClick(event) { const target = event.target; const clickedRow = target.closest('tr'); if (!clickedRow || !mdeForecastTbody.contains(clickedRow)) return; const week = clickedRow.dataset.week; const radio = clickedRow.querySelector('input[type="radio"]'); if (week && radio) { designKInput.value = week; applyKHighlight(week); checkIfStartAnalysisCanBeEnabled(); } }
        function handleKInputChange() { applyKHighlight(designKInput.value); checkIfStartAnalysisCanBeEnabled(); }
        function applyKHighlight(weekValue) { mdeForecastTbody.querySelectorAll('tr.selected-week').forEach(row => row.classList.remove('selected-week')); const weekNum = parseInt(weekValue); if (!isNaN(weekNum) && weekNum > 0) { const targetRow = mdeForecastTbody.querySelector(`tr[data-week="${weekNum}"]`); if (targetRow) { targetRow.classList.add('selected-week'); const targetRadio = targetRow.querySelector('input[type="radio"]'); if (targetRadio) targetRadio.checked = true; } else { mdeForecastTbody.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false); } } else { mdeForecastTbody.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false); } }
        
        function checkIfStartAnalysisCanBeEnabled() { const kValue = designKInput.value; const kNum = parseInt(kValue); const kIsValidAndSelected = !isNaN(kNum) && kNum > 0 && mdeForecastTbody.querySelector(`tr[data-week="${kNum}"].selected-week`); startAnalysisButton.disabled = !kIsValidAndSelected; if(startAnalysisHelpText) startAnalysisHelpText.textContent = kIsValidAndSelected ? `Prêt à calculer les bornes initiales pour ${kNum} semaine(s).` : "Sélectionnez une durée valide dans le tableau."; }


        // --- CORE LOGIC FUNCTIONS ---
        async function initializeDesignAndBoundaries() {
            const validatedK = parseInt(designKInput.value); 
            const testStartDateValue = testStartDateInput.value;
            if (!testStartDateValue) {
                alert("Veuillez spécifier la date de début du test à l'Étape 1.");
                testStartDateInput.focus();
                return;
            }

            if (isNaN(validatedK) || validatedK <= 0 || !mdeForecastTbody.querySelector(`tr[data-week="${validatedK}"].selected-week`)) { 
                alert("Sélectionnez une durée valide."); 
                return; 
            }
            if (weeklyEnteredData.length > 0 && (currentDesignParams?.k !== validatedK || currentDesignParams?.testStartDate !== testStartDateValue)) { 
                if (!confirm(`Changer les paramètres de planification (K=${validatedK}, Date début=${testStartDateValue}) réinitialisera les données entrées et les bornes. Continuer ?`)) { 
                    designKInput.value = currentDesignParams.k; 
                    testStartDateInput.value = currentDesignParams.testStartDate;
                    applyKHighlight(currentDesignParams.k); 
                    checkIfStartAnalysisCanBeEnabled(); return; 
                } 
                weeklyEnteredData = []; 
                resultsDiv.style.display = 'none'; 
                observedZDataPrincipal = []; 
                observedZDataSecondary = [];
            }
            
            startAnalysisButton.disabled = true; loadingDiv.style.display = 'block'; errorDivGen.textContent = ''; errorDivGen.style.display = 'none';
            
            const alpha = parseFloat(mdeConfidenceSelect.value); 
            const power = parseFloat(mdePowerSelect.value); 
            const testTypePrincipal = parseInt(mdeTestTypeSelect.value) || 1; 
            const sfu = designSpendingFunctionSelect.value; 
            const sfl = designSpendingFunctionLowerSelect.value;
            
            currentDesignParams = { k: validatedK, alpha, power, sfu, sfl, testTypePrincipal, testStartDate: testStartDateValue }; 
            
            secondaryMetricInputsA.style.display = isSecondaryKpiPlanned ? 'block' : 'none';
            secondaryMetricInputsB.style.display = isSecondaryKpiPlanned ? 'block' : 'none';
            historyTableSecondaryHeaderGroup.style.display = isSecondaryKpiPlanned ? 'table-cell' : 'none';
            historyTableSecondaryConvHeader.style.display = isSecondaryKpiPlanned ? 'table-cell' : 'none';
            historyTableSecondaryRateHeader.style.display = isSecondaryKpiPlanned ? 'table-cell' : 'none';

            let validationError = false; 
            if (isNaN(alpha) || alpha <= 0 || alpha >= 1) { showError("Alpha invalide.", false); validationError = true; } 
            if (isNaN(power) || power <= 0 || power >= 1) { showError("Puissance invalide.", false); validationError = true; } 
            const apiUrl = apiUrlInput.value; if (!apiUrl || !apiUrl.startsWith('http')) { showError("URL API invalide.", false); validationError = true; } 
            if (validationError) { loadingDiv.style.display = 'none'; startAnalysisButton.disabled = false; return; }

            try {
                const payloadPrincipal = { k: currentDesignParams.k, alpha: currentDesignParams.alpha, power: currentDesignParams.power, sfu: currentDesignParams.sfu, sfl: currentDesignParams.sfl, testType: currentDesignParams.testTypePrincipal };
                const responsePrincipal = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payloadPrincipal) }); 
                const initialApiResultPrincipal = await responsePrincipal.json();

                if (initialApiResultPrincipal.error === true || !responsePrincipal.ok) { let errMsg = initialApiResultPrincipal.message || `Erreur API (Principal) (${responsePrincipal.status})`; if(initialApiResultPrincipal.details) errMsg += ` Détails: ${initialApiResultPrincipal.details}`; throw new Error(errMsg); }
                currentBoundariesApiResultPrincipal = initialApiResultPrincipal;
                observedZDataPrincipal = new Array(currentDesignParams.k).fill(null);

                currentBoundariesApiResultSecondary = null; 
                observedZDataSecondary = new Array(currentDesignParams.k).fill(null);
                
                displayBoundariesTableAndChart(); 
                displayApiResults(); 
                
                dataEntrySection.style.display = 'block';
                updateDataEntryTitle(); // MODIFICATION: Mise à jour du titre
                historySection.style.display = 'none'; 
                toggleHistoryTableLink.textContent = "Modifier l'historique des données";
                totalStagesSpan.textContent = currentDesignParams.k; 
                renderProgressGauge(0, currentDesignParams.k);
                if (mdeAccordionButton && collapseMDE && !mdeAccordionButton.classList.contains('collapsed')) { $(collapseMDE).collapse('hide'); } 
                addDataButton.disabled = false;
            } catch (error) { 
                showError(`Erreur calcul design initial: ${error.message}`, false); 
                currentDesignParams = null; currentBoundariesApiResultPrincipal = null; currentBoundariesApiResultSecondary = null;
                resultsDiv.style.display = 'none'; dataEntrySection.style.display = 'none'; historySection.style.display = 'none';
            } finally { 
                loadingDiv.style.display = 'none'; startAnalysisButton.disabled = false; checkIfStartAnalysisCanBeEnabled(); 
            }
        }
        
        async function handleAddOrUpdateCumulativeData() {
            const isFirstDataEntry = weeklyEnteredData.length === 0;

            addDataButton.disabled = true; loadingDiv.style.display = 'block'; errorDivGen.textContent = ''; errorDivGen.style.display = 'none';
            try {
                if (!currentDesignParams) { alert("Design non initialisé. Veuillez d'abord planifier à l'Étape 1."); throw new Error("Design not initialized."); }
                
                const visitorsACumul = parseInt(controlVisitorsInput.value); 
                const conversionsACumul_P = parseInt(controlConversionsInput.value); 
                const visitorsBCumul = parseInt(variantVisitorsInput.value); 
                const conversionsBCumul_P = parseInt(variantConversionsInput.value);

                if (isNaN(visitorsACumul + conversionsACumul_P + visitorsBCumul + conversionsBCumul_P) || visitorsACumul < 0 || visitorsBCumul < 0 || conversionsACumul_P < 0 || conversionsBCumul_P < 0) { alert("Nombres valides (≥ 0) requis pour les données principales cumulées."); throw new Error("Invalid primary numbers."); }
                if (conversionsACumul_P > visitorsACumul || conversionsBCumul_P > visitorsBCumul) { alert("Conv. principales cumulées > Visiteurs cumulés?"); throw new Error("Primary Conversions>Visitors."); }

                let conversionsACumul_S = undefined; let conversionsBCumul_S = undefined; 
                
                if (isSecondaryKpiPlanned) { 
                     conversionsACumul_S = parseInt(controlConversionsSecondaryInput.value); 
                     conversionsBCumul_S = parseInt(variantConversionsSecondaryInput.value);
                     if (isNaN(conversionsACumul_S) || isNaN(conversionsBCumul_S) || conversionsACumul_S < 0 || conversionsBCumul_S < 0) { alert("Nombres valides (≥ 0) requis pour les conversions secondaires cumulées."); throw new Error("Invalid secondary conversion numbers."); }
                     if (conversionsACumul_S > visitorsACumul || conversionsBCumul_S > visitorsBCumul) { alert("Conv. secondaires cumulées > Visiteurs primaires cumulés?"); throw new Error("Secondary Conversions > Primary Visitors."); }
                }

                const currentStage = weeklyEnteredData.length + 1;
                if (currentStage > 1) {
                    const prevData = weeklyEnteredData[currentStage - 2];
                    if (visitorsACumul < prevData.visitorsACumul || visitorsBCumul < prevData.visitorsBCumul || conversionsACumul_P < prevData.conversionsACumul_P || conversionsBCumul_P < prevData.conversionsBCumul_P) { alert(`Données cumulées principales semaine ${currentStage} < semaine ${currentStage - 1}.`); throw new Error("Primary cumulative data decreased."); }
                    if (isSecondaryKpiPlanned && prevData.conversionsASecondaryCumul !== undefined) { 
                         const currentSecA = (conversionsACumul_S !== undefined && !isNaN(conversionsACumul_S)) ? conversionsACumul_S : -1; 
                         const currentSecB = (conversionsBCumul_S !== undefined && !isNaN(conversionsBCumul_S)) ? conversionsBCumul_S : -1; 
                         const prevSecA = prevData.conversionsASecondaryCumul !== undefined ? prevData.conversionsASecondaryCumul : -1; 
                         const prevSecB = prevData.conversionsBSecondaryCumul !== undefined ? prevData.conversionsBSecondaryCumul : -1;
                         if (currentSecA < prevSecA || currentSecB < prevSecB) { alert(`Données cumulées secondaires semaine ${currentStage} < semaine ${currentStage - 1}.`); throw new Error("Secondary cumulative data decreased."); }
                    }
                }
                if (currentStage > currentDesignParams.k) { alert(`Nombre maximum d'étapes (${currentDesignParams.k}) atteint.`); throw new Error("Max stages reached."); }

                const cumulativeDataForStage = { 
                    week: currentStage, 
                    visitorsACumul, conversionsACumul_P, 
                    visitorsBCumul, conversionsBCumul_P, 
                    conversionsASecondaryCumul: (isSecondaryKpiPlanned && conversionsACumul_S !== undefined && !isNaN(conversionsACumul_S)) ? conversionsACumul_S : undefined, 
                    conversionsBSecondaryCumul: (isSecondaryKpiPlanned && conversionsBCumul_S !== undefined && !isNaN(conversionsBCumul_S)) ? conversionsBCumul_S : undefined 
                };
                weeklyEnteredData.push(cumulativeDataForStage); weeklyEnteredData.sort((a, b) => a.week - b.week); 

                if (isFirstDataEntry && weeklyEnteredData.length > 0) {
                    resultsDiv.style.display = 'block';
                }

                const apiPayloadPrincipal = { 
                    k: currentDesignParams.k, alpha: currentDesignParams.alpha, power: currentDesignParams.power, 
                    sfu: currentDesignParams.sfu, sfl: currentDesignParams.sfl, testType: currentDesignParams.testTypePrincipal,
                    visitors_a: visitorsACumul, conversions_a: conversionsACumul_P, 
                    visitors_b: visitorsBCumul, conversions_b: conversionsBCumul_P 
                };
                const apiUrl = apiUrlInput.value; 
                const responsePrincipal = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(apiPayloadPrincipal) }); 
                const apiResultPrincipal = await responsePrincipal.json();
                if (apiResultPrincipal.error === true || !responsePrincipal.ok) { let errMsg = apiResultPrincipal.message || `Erreur API (Principal) (${responsePrincipal.status})`; if (apiResultPrincipal.details) errMsg += ` Détails: ${apiResultPrincipal.details}`; throw new Error(errMsg); }
                currentBoundariesApiResultPrincipal = apiResultPrincipal;

                currentBoundariesApiResultSecondary = null; 
                if (isSecondaryKpiPlanned && conversionsACumul_S !== undefined && conversionsBCumul_S !== undefined) {
                    const apiPayloadSecondary = {
                        k: currentDesignParams.k, alpha: currentDesignParams.alpha, power: currentDesignParams.power, 
                        sfu: currentDesignParams.sfu, sfl: currentDesignParams.sfl, testType: TEST_TYPE_SECONDARY_DEFAULT, 
                        visitors_a: visitorsACumul, conversions_a: conversionsACumul_S, 
                        visitors_b: visitorsBCumul, conversions_b: conversionsBCumul_S 
                    };
                    const responseSecondary = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(apiPayloadSecondary) });
                    const apiResultSecondary = await responseSecondary.json();
                    if (apiResultSecondary.error === true || !responseSecondary.ok) {
                        console.warn(`Erreur API (Secondaire): ${apiResultSecondary.message || responseSecondary.status}. Bornes du secondaire non mises à jour.`);
                    } else {
                        currentBoundariesApiResultSecondary = apiResultSecondary;
                    }
                }
                displayApiResults(); 
                prepareNextDataEntry();
                updateDataEntryTitle(); 
            } catch (error) { 
                showError(`Erreur traitement données cumulées: ${error.message}`, false);
            } finally { 
                addDataButton.disabled = false; loadingDiv.style.display = 'none'; checkIfDataEntryShouldBeEnabled(); 
            }
        }

        function displayApiResults() {
            if (!currentDesignParams) {
                console.warn("displayApiResults: currentDesignParams is null, resultsDiv content will not be updated.");
                return;
            }

            updateHistoryTable();
            const currentStage = weeklyEnteredData.length;
            
            let primaryLiftDataForChart = { name: 'Principal', lift: null, ci_low: null, ci_high: null, crA: null, crB: null };
            let secondaryLiftDataForChart = null;

            if (currentStage === 0) { 
                decisionDiv.textContent = `Prêt pour la semaine 1 sur ${currentDesignParams.k}. Entrez les données cumulées.`; 
                decisionDiv.className = 'alert col-md-4 decision-continue'; 
                errorDivGen.textContent = ''; errorDivGen.style.display = 'none'; 
                resultStageSpan.textContent = '0'; totalStagesSpan.textContent = currentDesignParams.k;
                
                crControlDisplay.textContent = 'N/A'; crVariantDisplay.textContent = 'N/A'; liftValueElement.textContent = 'N/A';
                zScorePrincipalDisplay.textContent = 'N/A';
                effBoundaryDisplayPrincipal.textContent = 'N/A'; futBoundaryDisplayPrincipal.textContent = 'N/A';
                updateBoundaryLabelSpans(currentDesignParams.testTypePrincipal, 'Principal');

                secondaryMetricResultsDiv.style.display = isSecondaryKpiPlanned ? 'block' : 'none';
                if (isSecondaryKpiPlanned) {
                    if (liftValueSecondaryElement) liftValueSecondaryElement.textContent = 'N/A';
                    if (zScoreSecondaryDisplay) zScoreSecondaryDisplay.textContent = 'N/A';
                    if (effBoundaryDisplaySecondary) effBoundaryDisplaySecondary.textContent = 'N/A';
                    if (futBoundaryDisplaySecondary) futBoundaryDisplaySecondary.textContent = 'N/A';
                }
                
                if (principalDetailsContainer) principalDetailsContainer.style.display = 'none';
                if (togglePrincipalDetailsLink) togglePrincipalDetailsLink.textContent = 'Voir plus de détails';
                if (secondaryDetailsContainer) secondaryDetailsContainer.style.display = 'none';
                if (toggleSecondaryDetailsLink) toggleSecondaryDetailsLink.textContent = 'Voir plus de détails';

                liftValueElement.classList.remove('lift-win', 'lift-loss'); if(liftValueSecondaryElement) liftValueSecondaryElement.classList.remove('lift-win', 'lift-loss');
                projectedGainDisplay.style.display = 'none'; 
                
                observedZDataPrincipal = new Array(currentDesignParams.k).fill(null);
                observedZDataSecondary = new Array(currentDesignParams.k).fill(null);
                
                if (currentBoundariesApiResultPrincipal && currentBoundariesApiResultPrincipal.boundaries) {
                    renderOrUpdateChart(0, currentBoundariesApiResultPrincipal, null, false); 
                } else {
                    if (chartContainer) chartContainer.innerHTML = '<p>Graphique des bornes (Principal) en attente d\'initialisation des bornes.</p>';
                }
                renderLiftVisualizationChart([primaryLiftDataForChart]);
                highlightBoundaryTableRow(0); 
                
                testProgressPercentageSpan.textContent = 'N/A'; // MODIFICATION: Sera mis à jour par renderProgressGauge
                renderProgressGauge(0, currentDesignParams.k);
                srmCheckIndicator.textContent = 'N/A'; srmCheckIndicator.className = '';
                prepareNextDataEntry();
                updateDataEntryTitle(); 
                return;
            }

            if (!currentBoundariesApiResultPrincipal || !currentBoundariesApiResultPrincipal.boundaries) {
                showError("Données des bornes principales non disponibles. Veuillez réinitialiser ou recharger.", resultsDiv.style.display === 'block'); 
                return; 
            }

            const lastCumulData = weeklyEnteredData[currentStage - 1];
            const cumVA = lastCumulData.visitorsACumul; 
            const cumCA_P = lastCumulData.conversionsACumul_P; 
            const cumVB = lastCumulData.visitorsBCumul; 
            const cumCB_P = lastCumulData.conversionsBCumul_P;
            
            const crAPrimary = cumVA > 0 ? cumCA_P / cumVA : 0; 
            const crBPrimary = cumVB > 0 ? cumCB_P / cumVB : 0;
            const liftPrimary = crAPrimary > 0 ? ((crBPrimary - crAPrimary) / crAPrimary) * 100 : (crBPrimary > 0 ? Infinity : 0);
            const varianceAPrimary = cumVA > 1 ? crAPrimary * (1 - crAPrimary) / cumVA : NaN; 
            const varianceBPrimary = cumVB > 1 ? crBPrimary * (1 - crBPrimary) / cumVB : NaN;
            checkSRM(cumVA, cumVB);

            primaryLiftDataForChart.crA = crAPrimary; primaryLiftDataForChart.crB = crBPrimary; primaryLiftDataForChart.lift = isFinite(liftPrimary) ? liftPrimary : null;
            if (isFinite(liftPrimary) && !isNaN(varianceAPrimary) && !isNaN(varianceBPrimary) && varianceAPrimary >= 0 && varianceBPrimary >= 0 && crAPrimary > 0) { const SE_diff_primary = Math.sqrt(varianceAPrimary + varianceBPrimary); const Z_CRIT_95 = 1.96; const diff_abs_lower = (crBPrimary - crAPrimary) - Z_CRIT_95 * SE_diff_primary; const diff_abs_upper = (crBPrimary - crAPrimary) + Z_CRIT_95 * SE_diff_primary; primaryLiftDataForChart.ci_low = (diff_abs_lower / crAPrimary) * 100; primaryLiftDataForChart.ci_high = (diff_abs_upper / crAPrimary) * 100; }

            const z_principal_from_api = currentBoundariesApiResultPrincipal.observedZ;
            const zPrincipalIsValid = typeof z_principal_from_api === 'number' && isFinite(z_principal_from_api);
            const boundsPrincipal = currentBoundariesApiResultPrincipal.boundaries?.find(b => b.stage === currentStage);

            if (!boundsPrincipal) { 
                showError(`Erreur: Bornes (Principal) étape ${currentStage} non trouvées.`, false); 
                return; 
            }
            const effB_principal = boundsPrincipal.efficacyZ; 
            const futB_principal = boundsPrincipal.futilityZ;
            if (currentStage > 0 && currentStage <= currentDesignParams.k) observedZDataPrincipal[currentStage - 1] = zPrincipalIsValid ? parseFloat(z_principal_from_api.toFixed(4)) : null;


            let z_secondary_from_api = NaN, zSecondaryIsValid = false, effB_secondary = NaN, futB_secondary = NaN;
            let crASecondary = NaN, crBSecondary = NaN, liftSecondary = NaN, varianceASecondaryCalc = NaN, varianceBSecondaryCalc = NaN;
            const cumCA_S = lastCumulData.conversionsASecondaryCumul; 
            const cumCB_S = lastCumulData.conversionsBSecondaryCumul; 
            
            if (isSecondaryKpiPlanned && cumCA_S !== undefined && cumCB_S !== undefined && currentBoundariesApiResultSecondary && currentBoundariesApiResultSecondary.boundaries) {
                secondaryLiftDataForChart = { name: 'Sécurité', lift: null, ci_low: null, ci_high: null, crA: null, crB: null };
                crASecondary = cumVA > 0 ? cumCA_S / cumVA : 0; 
                crBSecondary = cumVB > 0 ? cumCB_S / cumVB : 0;

                secondaryLiftDataForChart.crA = crASecondary; secondaryLiftDataForChart.crB = crBSecondary;
                liftSecondary = crASecondary > 0 ? ((crBSecondary - crASecondary) / crASecondary) * 100 : (crBSecondary > 0 ? Infinity : 0);
                varianceASecondaryCalc = cumVA > 1 ? crASecondary * (1 - crASecondary) / cumVA : NaN;
                varianceBSecondaryCalc = cumVB > 1 ? crBSecondary * (1 - crBSecondary) / cumVB : NaN;
                secondaryLiftDataForChart.lift = isFinite(liftSecondary) ? liftSecondary : null;
                if (isFinite(liftSecondary) && !isNaN(varianceASecondaryCalc) && !isNaN(varianceBSecondaryCalc) && varianceASecondaryCalc >= 0 && varianceBSecondaryCalc >= 0 && crASecondary > 0) { const SE_diff_secondary = Math.sqrt(varianceASecondaryCalc + varianceBSecondaryCalc); const Z_CRIT_95 = 1.96; const diff_abs_lower_sec = (crBSecondary - crASecondary) - Z_CRIT_95 * SE_diff_secondary; const diff_abs_upper_sec = (crBSecondary - crASecondary) + Z_CRIT_95 * SE_diff_secondary; secondaryLiftDataForChart.ci_low = (diff_abs_lower_sec / crASecondary) * 100; secondaryLiftDataForChart.ci_high = (diff_abs_upper_sec / crASecondary) * 100; }
                
                z_secondary_from_api = currentBoundariesApiResultSecondary.observedZ;
                zSecondaryIsValid = typeof z_secondary_from_api === 'number' && isFinite(z_secondary_from_api);
                const boundsSecondary = currentBoundariesApiResultSecondary.boundaries?.find(b => b.stage === currentStage);
                if (boundsSecondary) {
                    effB_secondary = boundsSecondary.efficacyZ; 
                    futB_secondary = boundsSecondary.futilityZ; 
                } else {
                    console.warn(`Bornes (Secondaire) étape ${currentStage} non trouvées.`);
                    effB_secondary = NaN; futB_secondary = NaN; 
                }
                if (currentStage > 0 && currentStage <= currentDesignParams.k) observedZDataSecondary[currentStage - 1] = zSecondaryIsValid ? parseFloat(z_secondary_from_api.toFixed(4)) : null;
                secondaryMetricResultsDiv.style.display = 'block';
            } else {
                secondaryMetricResultsDiv.style.display = 'none';
                if (currentStage > 0 && currentStage <= currentDesignParams.k) observedZDataSecondary[currentStage - 1] = null;
            }

            // MODIFICATION START: Logique de décision révisée selon les scénarios
            let decisionText = ""; 
            let decisionClass = "decision-continue"; 
            const tTypePrincipal = currentDesignParams.testTypePrincipal;

            let principalStateEval = INDICATOR_STATE.NEUTRAL;
            if (zPrincipalIsValid && isFinite(effB_principal) && z_principal_from_api >= effB_principal) {
                principalStateEval = INDICATOR_STATE.POSITIVE;
            } else if (zPrincipalIsValid && isFinite(futB_principal) && z_principal_from_api <= futB_principal) {
                principalStateEval = INDICATOR_STATE.NEGATIVE;
            }

            let secondaryStateEval = INDICATOR_STATE.NEUTRAL; // Par défaut pour "pas de KPI de sécurité" ou "OK/Neutre"
            if (isSecondaryKpiPlanned) {
                if (zSecondaryIsValid && isFinite(futB_secondary) && z_secondary_from_api <= futB_secondary) {
                    secondaryStateEval = INDICATOR_STATE.NEGATIVE; // Régression claire
                } else if (zSecondaryIsValid && isFinite(effB_secondary) && z_secondary_from_api >= effB_secondary) {
                    secondaryStateEval = INDICATOR_STATE.POSITIVE; // Non-régression claire (donc OK)
                } else if (zSecondaryIsValid && isFinite(effB_secondary) && z_secondary_from_api < effB_secondary && (!isFinite(futB_secondary) || z_secondary_from_api > futB_secondary)) {
                    secondaryStateEval = INDICATOR_STATE.RISK_NEGATIVE; // Dans la zone d'incertitude, risque de régression
                }
                 // Si zSecondaryIsValid est false, ou bornes non finies, reste NEUTRAL (non concluant)
            }

            if (principalStateEval === INDICATOR_STATE.POSITIVE) {
                if (!isSecondaryKpiPlanned || secondaryStateEval === INDICATOR_STATE.POSITIVE || secondaryStateEval === INDICATOR_STATE.NEUTRAL) {
                    decisionClass = "decision-stop-win"; // Scénario 1
                    decisionText = `<strong>ARRÊTER - DÉPLOIEMENT RECOMMANDÉ :</strong><br>L'objectif principal est positif. ${isSecondaryKpiPlanned ? "L'objectif de sécurité est neutre ou positif." : ""}`;
                } else if (secondaryStateEval === INDICATOR_STATE.RISK_NEGATIVE) {
                    decisionClass = "decision-discuss"; // Scénario 2
                    decisionText = `<strong>ARRÊTER - DISCUSSION REQUISE :</strong><br>L'objectif principal est positif, mais l'objectif de sécurité présente un risque de régression.`;
                } else if (secondaryStateEval === INDICATOR_STATE.NEGATIVE) {
                    decisionClass = "decision-stop-critical"; // Scénario 3
                    decisionText = `<strong>ARRÊTER - NE PAS DÉPLOYER :</strong><br>L'objectif principal est positif, MAIS l'objectif de sécurité est négatif.`;
                }
            } else if (principalStateEval === INDICATOR_STATE.NEUTRAL) {
                if (isSecondaryKpiPlanned && secondaryStateEval === INDICATOR_STATE.NEGATIVE) {
                    decisionClass = "decision-stop-critical"; // Scénario 4
                    decisionText = `<strong>ARRÊTER - NE PAS DÉPLOYER :</strong><br>L'objectif principal est neutre, et l'objectif de sécurité est négatif.`;
                } else if (currentStage === currentDesignParams.k) {
                    decisionClass = "decision-stop-futility";
                    decisionText = `<strong>ARRÊTER - TEST TERMINÉ, NON CONCLUANT :</strong><br>L'objectif principal est neutre après ${currentDesignParams.k} semaines.`;
                    if (isSecondaryKpiPlanned && secondaryStateEval === INDICATOR_STATE.POSITIVE) decisionText += " L'objectif de sécurité est OK.";
                     else if (isSecondaryKpiPlanned) decisionText += " L'objectif de sécurité est neutre ou à risque.";
                } else {
                    decisionClass = "decision-continue";
                    decisionText = `<strong>CONTINUER :</strong><br>Analyse pour semaine ${currentStage + 1} nécessaire. Objectif principal neutre.`;
                     if (isSecondaryKpiPlanned && secondaryStateEval === INDICATOR_STATE.POSITIVE) decisionText += " Objectif de sécurité OK.";
                     else if (isSecondaryKpiPlanned && secondaryStateEval === INDICATOR_STATE.RISK_NEGATIVE) decisionText += " Objectif de sécurité à risque.";
                }
            } else if (principalStateEval === INDICATOR_STATE.NEGATIVE) {
                 decisionClass = "decision-stop-futility"; // Scénario 5
                 decisionText = `<strong>ARRÊTER - NE PAS DÉPLOYER :</strong><br>L'objectif principal est négatif.`;
                 if (isSecondaryKpiPlanned && secondaryStateEval === INDICATOR_STATE.NEGATIVE) decisionText += " L'objectif de sécurité est également négatif.";
                 else if (isSecondaryKpiPlanned) decisionText += ` L'objectif de sécurité est ${secondaryStateEval === INDICATOR_STATE.POSITIVE ? "positif" : "neutre ou à risque"}.`;
            }

            // Gestion de la fin du test si toujours en "continuer"
            if (decisionClass === "decision-continue" && currentStage === currentDesignParams.k) {
                decisionClass = "decision-stop-futility";
                decisionText = `<strong>ARRÊTER - TEST TERMINÉ, NON CONCLUANT :</strong><br>Aucun résultat significatif clair après ${currentDesignParams.k} semaines.`;
            }
            // MODIFICATION END
            
            displayResultsDetails(currentStage, 
                crAPrimary, crBPrimary, liftPrimary, z_principal_from_api, zPrincipalIsValid, effB_principal, futB_principal,
                crASecondary, crBSecondary, liftSecondary, z_secondary_from_api, zSecondaryIsValid, effB_secondary, futB_secondary, 
                decisionText, "alert " + decisionClass, // Ajout de "alert " pour Bootstrap
                varianceAPrimary, varianceBPrimary, varianceASecondaryCalc, varianceBSecondaryCalc);
            
            if (currentBoundariesApiResultPrincipal && currentBoundariesApiResultPrincipal.boundaries) {
                 renderOrUpdateChart(currentStage, currentBoundariesApiResultPrincipal, z_principal_from_api, zPrincipalIsValid);
            } else {
                if (chartContainer) chartContainer.innerHTML = '<p>Graphique des bornes (Principal) : données de bornes manquantes.</p>';
            }
            
            const liftChartDataArray = [primaryLiftDataForChart]; 
            if (secondaryLiftDataForChart) liftChartDataArray.push(secondaryLiftDataForChart);
            renderLiftVisualizationChart(liftChartDataArray);
            
            checkIfDataEntryShouldBeEnabled();
            resultStageSpan.textContent = currentStage;
            renderProgressGauge(currentStage, currentDesignParams.k); // testProgressPercentageSpan sera mis à jour ici
        }

        function displayResultsDetails(stage, 
                                   crA_p, crB_p, lift_p, z_p, zValid_p, effB_p, futB_p,
                                   crA_s, crB_s, lift_s, z_s, zValid_s, effB_s, futB_s,
                                   decText, decClass, 
                                   varA_p, varB_p, varA_s, varB_s) {
            
            decisionDiv.innerHTML = decText; 
            decisionDiv.className = decClass + ' col-md-4'; // S'assurer que la classe col-md-4 est conservée

            if (crControlDisplay) crControlDisplay.textContent = formatNumberForDisplay(crA_p * 100, 2) + '%'; 
            if (crVariantDisplay) crVariantDisplay.textContent = formatNumberForDisplay(crB_p * 100, 2) + '%'; 
            if (crControlVarianceElement) crControlVarianceElement.textContent = !isNaN(varA_p) && varA_p >= 0 ? `(±${(Math.sqrt(varA_p) * 100).toFixed(1)}%)` : ''; 
            if (crVariantVarianceElement) crVariantVarianceElement.textContent = !isNaN(varB_p) && varB_p >= 0 ? `(±${(Math.sqrt(varB_p) * 100).toFixed(1)}%)` : ''; 
            if (liftValueElement) liftValueElement.textContent = isFinite(lift_p) ? formatNumberForDisplay(lift_p, 2) + '%' : lift_p > 0 ? '+∞%' : 'N/A'; 
            if (zScorePrincipalDisplay) zScorePrincipalDisplay.textContent = zValid_p ? formatNumberForDisplay(z_p, 3) : 'N/A'; 
            
            updateBoundaryLabelSpans(currentDesignParams.testTypePrincipal, 'Principal');
            if (effBoundaryDisplayPrincipal) effBoundaryDisplayPrincipal.textContent = formatNumberForDisplay(effB_p, 3); 
            if (futBoundaryDisplayPrincipal) futBoundaryDisplayPrincipal.textContent = formatNumberForDisplay(futB_p, 3); 

            if (liftValueElement) { 
                if (decClass.includes('decision-stop-win') && lift_p > 0) { liftValueElement.className = 'liftValueItem lift-win'; }
                else if (decClass.includes('decision-stop-futility') && lift_p < 0) { liftValueElement.className = 'liftValueItem lift-loss'; }
                else if (decClass.includes('decision-stop-critical') && lift_p < 0) { liftValueElement.className = 'liftValueItem lift-loss';} 
                else if (decClass.includes('decision-stop-critical') && lift_p > 0) { liftValueElement.className = 'liftValueItem lift-win';} 
                else { liftValueElement.className = 'liftValueItem'; liftValueElement.style.color = 'var(--lift-default-color)';}
            }

            if (decClass.includes('decision-stop-win') && zValid_p) { 
                const baseTraffic = parseFloat(baselineTrafficInput.value); 
                if (!isNaN(baseTraffic) && baseTraffic > 0) { 
                    const crDiff = crB_p - crA_p; const weeklyGain = baseTraffic * crDiff; const monthlyGain = weeklyGain * 4.33; 
                    projectedGainDisplay.textContent = `Gain mensuel estimé (Principal) : ~${Math.round(monthlyGain).toLocaleString()} conversions supplémentaires.`; 
                    projectedGainDisplay.style.display = 'block'; 
                } else { 
                    projectedGainDisplay.textContent = "Gain mensuel estimé (Principal) : Trafic hebdo. non défini."; 
                    projectedGainDisplay.style.display = 'block'; 
                } 
            } else { 
                projectedGainDisplay.style.display = 'none'; 
            }

            if (isSecondaryKpiPlanned && crA_s !== undefined && !isNaN(crA_s)) { 
                secondaryMetricResultsDiv.style.display = 'block';
                if(crControlSecondaryDisplay) crControlSecondaryDisplay.textContent = formatNumberForDisplay(crA_s * 100, 2) + '%'; 
                if(crVariantSecondaryDisplay) crVariantSecondaryDisplay.textContent = formatNumberForDisplay(crB_s * 100, 2) + '%'; 
                if (crControlSecondaryVarianceElement) crControlSecondaryVarianceElement.textContent = !isNaN(varA_s) && varA_s >= 0 ? `(±${(Math.sqrt(varA_s) * 100).toFixed(1)}%)` : ''; 
                if (crVariantSecondaryVarianceElement) crVariantSecondaryVarianceElement.textContent = !isNaN(varB_s) && varB_s >= 0 ? `(±${(Math.sqrt(varB_s) * 100).toFixed(1)}%)` : ''; 
                
                if(liftValueSecondaryElement) liftValueSecondaryElement.textContent = isFinite(lift_s) ? formatNumberForDisplay(lift_s, 2) + '%' : lift_s > 0 ? '+∞%' : 'N/A'; 
                if(zScoreSecondaryDisplay) zScoreSecondaryDisplay.textContent = zValid_s ? formatNumberForDisplay(z_s, 3) : 'N/A'; 
                if(effBoundaryDisplaySecondary) effBoundaryDisplaySecondary.textContent = formatNumberForDisplay(effB_s, 3); 
                if(futBoundaryDisplaySecondary) futBoundaryDisplaySecondary.textContent = formatNumberForDisplay(futB_s, 3); 

                if (liftValueSecondaryElement) { 
                    liftValueSecondaryElement.className = 'liftValueItem';
                    liftValueSecondaryElement.style.color = 'var(--lift-default-color)';
                    // La couleur du lift secondaire est déjà gérée par le tableau de visualisation
                }
            } else {
                secondaryMetricResultsDiv.style.display = 'none';
            }
            highlightBoundaryTableRow(stage); 
        }

        function checkIfDataEntryShouldBeEnabled() { addDataButton.disabled = (weeklyEnteredData.length >= (currentDesignParams?.k || Infinity)); }
        function prepareNextDataEntry() { dataForm.reset(); controlVisitorsInput.focus(); }
        
        function toggleHistoryTable(event) { 
            event.preventDefault(); 
            const isHidden = historySection.style.display === 'none'; 
            historySection.style.display = isHidden ? 'block' : 'none'; 
            toggleHistoryTableLink.textContent = isHidden ? "Masquer l'historique" : "Modifier l'historique des données";
        }

        function toggleBoundariesTable(event) { event.preventDefault(); const isHidden = boundariesTableContainer.style.display === 'none'; boundariesTableContainer.style.display = isHidden ? 'block' : 'none'; toggleBoundariesTableLink.textContent = isHidden ? "Masquer les bornes séquentielles (Obj. Principal)" : "Voir les bornes séquentielles (Obj. Principal)"; }
        
        function displayBoundariesTableAndChart() { 
            if (!currentBoundariesApiResultPrincipal || !currentBoundariesApiResultPrincipal.boundaries || !currentDesignParams) {
                if(boundariesTbody) boundariesTbody.innerHTML = '<tr><td colspan="4">Données de bornes non disponibles.</td></tr>';
                if(chartContainer) chartContainer.innerHTML = '<p>Graphique des bornes (Principal) : données de bornes non disponibles.</p>';
                return;
            }
            errorDivGen.textContent = ''; errorDivGen.style.display = 'none'; 
            const k = currentDesignParams.k; 
            const testType = currentDesignParams.testTypePrincipal;
            
            if (boundariesTbody) boundariesTbody.innerHTML = ''; else { console.error("boundariesTbody is null!"); return; }
            updateBoundaryTableHeaders(testType); 
            
            currentBoundariesApiResultPrincipal.boundaries.forEach(b => { 
                const row = boundariesTbody.insertRow(); 
                row.insertCell().textContent = formatNumberForDisplay(b.stage, 0); 
                row.insertCell().textContent = formatNumberForDisplay(b.infoFraction, 4); 
                row.insertCell().textContent = formatNumberForDisplay(b.efficacyZ, 3); 
                row.insertCell().textContent = formatNumberForDisplay(b.futilityZ, 3); 
            });
            observedZDataPrincipal = new Array(k).fill(null); 
            
            if(chartContainer) chartContainer.style.display = 'block';
            
            setTimeout(() => { 
                renderOrUpdateChart(0, currentBoundariesApiResultPrincipal, null, false); 
            }, 0);
            highlightBoundaryTableRow(0);
        }

        function updateBoundaryLabelSpans(testType, indicatorSuffix) { const effSpan = document.getElementById(`upperBoundType${indicatorSuffix}`); const futSpan = document.getElementById(`lowerBoundType${indicatorSuffix}`); if (testType === 1) { if (effSpan) effSpan.textContent = "Supériorité"; if (futSpan) futSpan.textContent = "Futilité"; } else if (testType === 3) { if (effSpan) effSpan.textContent = "Non-Rég."; if (futSpan) futSpan.textContent = "Régression"; } else { if (effSpan) effSpan.textContent = "B > A"; if (futSpan) futSpan.textContent = "A > B"; } }
        function updateBoundaryTableHeaders(testType) { if (testType === 1) { upperBoundLabelPrincipalTableTh.textContent = "Z Borne Sup (Supériorité)"; lowerBoundLabelPrincipalTableTh.textContent = "Z Borne Inf (Futilité)"; } else if (testType === 3) { upperBoundLabelPrincipalTableTh.textContent = "Z Borne Sup (Non-Rég.)"; lowerBoundLabelPrincipalTableTh.textContent = "Z Borne Inf (Régression)"; } else { upperBoundLabelPrincipalTableTh.textContent = "Z Borne Sup (B > A)"; lowerBoundLabelPrincipalTableTh.textContent = "Z Borne Inf (A > B)"; } }

        const formatNumberForDisplay = (v, p = 3) => { if (typeof v === 'number' && isFinite(v)) { return v.toFixed(p); } else if (v === Infinity) { return "+∞"; } else if (v === -Infinity) { return "-∞"; } else { return 'N/A'; } };
        function highlightBoundaryTableRow(stage) { boundariesTbody.querySelectorAll('tr.current-stage-row').forEach(r => r.classList.remove('current-stage-row')); if (stage > 0 && currentDesignParams && stage <= currentDesignParams.k) { const rowToHighlight = boundariesTbody.rows[stage - 1]; if (rowToHighlight) rowToHighlight.classList.add('current-stage-row'); } }


        function renderLiftVisualizationChart(indicatorDataArray) { 
            if (!liftVisualizationTbody) { return; }
             if (document.hidden) { return; }
            liftVisualizationTbody.innerHTML = ''; 
            Object.values(liftChartInstances).forEach(chart => { if (chart && typeof chart.destroy === 'function') chart.destroy(); });
            liftChartInstances = {};
            let globalYMin = 0, globalYMax = 0; const allPossibleValues = [0];
            indicatorDataArray.forEach(data => { if (data.lift !== null && isFinite(data.lift)) allPossibleValues.push(data.lift); if (data.ci_low !== null && isFinite(data.ci_low)) allPossibleValues.push(data.ci_low); if (data.ci_high !== null && isFinite(data.ci_high)) allPossibleValues.push(data.ci_high); });
            if (allPossibleValues.length > 1) { const minVal = Math.min(...allPossibleValues); const maxVal = Math.max(...allPossibleValues); const absMax = Math.max(Math.abs(minVal), Math.abs(maxVal), 5); const padding = absMax * 0.2; globalYMin = -(absMax + padding); globalYMax = absMax + padding; } else { globalYMin = -25; globalYMax = 25; }

            setTimeout(() => { 
                indicatorDataArray.forEach((data, index) => {
                    const chartId = `lift-chart-${index}`; 
                    const row = liftVisualizationTbody.insertRow(); 
                    row.insertCell().textContent = data.name;
                    row.insertCell().textContent = data.crA !== null ? formatNumberForDisplay(data.crA * 100, 2) + '%' : 'N/A';
                    row.insertCell().textContent = data.crB !== null ? formatNumberForDisplay(data.crB * 100, 2) + '%' : 'N/A';
                    const liftCell = row.insertCell(); 
                    
                    let liftHtml = data.lift !== null ? formatNumberForDisplay(data.lift, 2) + '%' : 'N/A';
                    let liftColor = 'var(--lift-default-color)';
                    liftCell.classList.remove('gain-positive', 'gain-negative'); // Reset classes

                    const currentStageDataIdx = weeklyEnteredData.length -1;
                    let indicatorIsPositive = false;
                    let indicatorIsNegative = false;

                    if (data.name === "Principal" && currentBoundariesApiResultPrincipal && currentStageDataIdx >=0) {
                        const z_val = observedZDataPrincipal[currentStageDataIdx];
                        const bounds = currentBoundariesApiResultPrincipal.boundaries?.find(b => b.stage === (currentStageDataIdx + 1));
                        if (bounds && typeof z_val === 'number' && isFinite(z_val)){
                            if (z_val >= bounds.efficacyZ) indicatorIsPositive = true;
                            if (z_val <= bounds.futilityZ) indicatorIsNegative = true;
                        }
                    } else if (data.name === "Sécurité" && currentBoundariesApiResultSecondary && currentStageDataIdx >=0) {
                         const z_val_sec = observedZDataSecondary[currentStageDataIdx];
                         const bounds_sec = currentBoundariesApiResultSecondary.boundaries?.find(b => b.stage === (currentStageDataIdx + 1));
                         if (bounds_sec && typeof z_val_sec === 'number' && isFinite(z_val_sec)) {
                            if (z_val_sec >= bounds_sec.efficacyZ) indicatorIsPositive = true; // Non-régression = positif pour la sécurité
                            if (z_val_sec <= bounds_sec.futilityZ) indicatorIsNegative = true; // Régression = négatif pour la sécurité
                         }
                    }
                    
                    if (indicatorIsPositive && data.lift > 0.01) { // Seuil pour considérer comme positif
                        liftCell.classList.add('gain-positive');
                        liftHtml = `<span class="arrow-up">&#9650;</span> ${liftHtml}`;
                        liftColor = 'var(--gain-positive-text)';
                    } else if (indicatorIsNegative && data.lift < -0.01) { // Seuil pour considérer comme négatif
                        liftCell.classList.add('gain-negative');
                        liftHtml = `<span class="arrow-down">&#9660;</span> ${liftHtml}`;
                        liftColor = 'var(--gain-negative-text)';
                    }
                    liftCell.innerHTML = liftHtml;


                    const chartCell = row.insertCell(); 
                    chartCell.id = chartId; 
                    chartCell.classList.add('lift-chart-cell');
                    
                    if (data.lift === null && data.ci_low === null && data.ci_high === null) { chartCell.innerHTML = "<span style='font-size:0.8em; color: #888;'>Données insuffisantes</span>"; return; } 
                    
                    const chartOptions = {
                        chart: { type: 'column', inverted: true, height: 35, style: { fontFamily: 'Poppins, sans-serif' }, marginTop: 2, marginBottom: 2, marginLeft:0, marginRight:0, spacing: [0,0,0,0] },
                        title: { text: null }, xAxis: { categories: [''], visible: false },
                        yAxis: { min: globalYMin, max: globalYMax, title: null, labels: { enabled: false }, gridLineWidth: 0, plotLines: [{ value: 0, color: '#ccc', width: 1, zIndex: 5 }] },
                        legend: { enabled: false },
                        tooltip: { 
                            enabled: true, 
                            formatter: function() { let liftVal = data.lift !== null ? formatNumberForDisplay(data.lift, 2) + '%' : 'N/A'; let ciRange = (data.ci_low !== null && data.ci_high !== null) ? `[${formatNumberForDisplay(data.ci_low, 2)}%, ${formatNumberForDisplay(data.ci_high, 2)}%]` : 'N/A'; return `<b>${data.name}</b><br/>Lift: ${liftVal}<br/>IC 95%: ${ciRange}`; },
                            zIndex: 1070 // MODIFICATION: zIndex pour l'infobulle
                        },
                        plotOptions: { columnrange: { pointWidth: 18, grouping: false, dataLabels: { enabled: false }, borderWidth: 0, color: '#D3D3D3', borderRadius: 3 }, scatter: { marker: { symbol: 'circle', radius: 5, lineWidth: 0 }, zIndex: 5 } },
                        series: [{ name: 'Intervalle de Confiance', type: 'columnrange', data: (data.ci_low !== null && data.ci_high !== null) ? [[data.ci_low, data.ci_high]] : [], enableMouseTracking: false },
                                 { name: 'Lift Estimé', type: 'scatter', data: (data.lift !== null) ? [[0, data.lift]] : [], color: liftColor }
                                ],
                        credits: { enabled: false }
                    };
                    try { 
                        liftChartInstances[chartId] = Highcharts.chart(chartId, chartOptions); 
                    }
                    catch(e) { console.error("Erreur création mini-graphique lift:", e, chartId); document.getElementById(chartId).innerHTML = "<span style='font-size:0.8em; color:red;'>Erreur</span>"; }
                });
            }, 0);
        }

        function renderOrUpdateChart(currentStage, boundariesApiResultForChart, currentZScore, isZScoreValid) { 
             if (!chartContainer) { return; }
             chartContainer.style.display = 'block'; 
             if (document.hidden) { return; }

             setTimeout(() => { 
                try {
                     const kParamApi = boundariesApiResultForChart?.parameters?.k; 
                     const numAnalyses = (typeof kParamApi === 'number' && kParamApi > 0) ? kParamApi : (currentDesignParams?.k || 0); 
                     if (numAnalyses <= 0 || !boundariesApiResultForChart || !boundariesApiResultForChart.boundaries) { 
                         if (chartInstance) { chartInstance.destroy(); chartInstance = null; } 
                         chartContainer.innerHTML = '<p>Graphique des bornes (Principal) : Données de bornes insuffisantes ou K invalide.</p>'; 
                         return; 
                     } 
                     if(chartContainer.querySelector('p')) chartContainer.innerHTML = ''; 

                     const categories = Array.from({ length: numAnalyses }, (_, i) => `Étape ${i + 1}`); 
                     const upperSeriesData = boundariesApiResultForChart.boundaries.map(b => b.efficacyZ); 
                     const lowerSeriesData = boundariesApiResultForChart.boundaries.map(b => b.futilityZ); 
                     const zSeriesData = observedZDataPrincipal.slice(0, numAnalyses); 
                     
                     const testType = currentDesignParams?.testTypePrincipal || 1; 
                     const uBL = testType === 1 ? "Supériorité" : (testType === 3 ? "Non-Rég." : "B > A"); 
                     const lBL = testType === 1 ? "Futilité" : (testType === 3 ? "Régression" : "A > B"); 
                     
                     const allFiniteValues = [ ...upperSeriesData, ...lowerSeriesData, ...zSeriesData.filter(z => z !== null && isFinite(z)) ].filter(v => typeof v === 'number' && isFinite(v));
                     let yMin = allFiniteValues.length > 0 ? Math.min(...allFiniteValues) : -3.5;
                     let yMax = allFiniteValues.length > 0 ? Math.max(...allFiniteValues) : 3.5;
                     if (yMin === yMax && allFiniteValues.length > 0) { yMin -=1; yMax +=1; } 
                     else if (yMin === yMax && allFiniteValues.length === 0) {yMin = -3.5; yMax = 3.5;} 
                     
                     const pad = Math.max(1.0, (yMax - yMin) * 0.1); 
                     const plotMin = Math.floor(yMin - pad); 
                     const plotMax = Math.ceil(yMax + pad); 
                     const effZone = upperSeriesData.map((v, i) => (typeof v === 'number' && isFinite(v)) ? [i, v, plotMax] : [i, null, null]).filter(p => p[1] !== null); 
                     const futZone = lowerSeriesData.map((v, i) => (typeof v === 'number' && isFinite(v)) ? [i, plotMin, v] : [i, null, null]).filter(p => p[1] !== null);
                     
                     const chartOptions = { chart: { type: "spline", style: { fontFamily: 'Poppins, sans-serif' } }, title: { text: "Analyse Séquentielle (Objectif Principal)" }, xAxis: { categories, title: { text: "Étape d'Analyse" } }, yAxis: { title: { text: "Valeur Z (Principal)" }, min: plotMin, max: plotMax, plotLines: [{ value: 0, color: "#888", dashStyle: "Solid", width: 1, zIndex: 3 }] }, tooltip: { shared: true, useHTML: true, formatter: function () { let s = `<b>${this.x}</b><br/>`; const pts = this.points.sort((a,b) => a.series.name.includes("Z cumulé") ? 1 : b.series.name.includes("Z cumulé") ? -1 : a.series.index - b.series.index); pts.forEach(p => { if (p.series.type !== 'arearange' && p.y !== null && p.y !== undefined) { s += `<span style="color:${p.color}">\u25CF</span> ${p.series.name}: <b>${formatNumberForDisplay(p.y, 3)}</b><br/>`; }}); return s; } }, plotOptions: { spline: { marker: { enabled: true, radius: 3 }, connectNulls: false }, arearange: { lineWidth: 0, marker: { enabled: false }, showInLegend: false, enableMouseTracking: false, zIndex: 0, fillOpacity: 0.30 } }, series: [ { name: 'Zone Efficacité', type: 'arearange', data: effZone, color: 'rgba(40, 167, 69, 0.30)' }, { name: 'Zone Futilité/Inf', type: 'arearange', data: futZone, color: 'rgba(220, 53, 69, 0.30)' }, { name: `Borne Sup (${uBL})`, data: upperSeriesData, color: "#28a745", zIndex: 2, dashStyle: "ShortDot", lineWidth: 1.5, marker:{enabled:false} }, { name: `Borne Inf (${lBL})`, data: lowerSeriesData, color: "#dc3545", zIndex: 2, dashStyle: "ShortDot", lineWidth: 1.5, marker:{enabled:false} }, { name: "Z cumulé observé (Principal)", data: zSeriesData, color: "#005ff8", zIndex: 4, lineWidth: 2.5, marker: { symbol: 'circle', radius: 4 } } ], credits: { enabled: false } };
                     
                     if (chartInstance && chartInstance.series && chartInstance.series.length > 0) { 
                         const curCats = chartInstance.xAxis[0].categories; 
                         const needsCatUpd = !curCats || curCats.length !== categories.length || curCats.some((c, i) => c !== categories[i]); 
                         if (needsCatUpd) { chartInstance.xAxis[0].setCategories(categories, false); } 
                         chartInstance.yAxis[0].update({ min: plotMin, max: plotMax }, false); 
                         chartInstance.series[0].setData(effZone, false); 
                         chartInstance.series[1].setData(futZone, false); 
                         chartInstance.series[2].update({ name: `Borne Sup (${uBL})`, data: upperSeriesData }, false); 
                         chartInstance.series[3].update({ name: `Borne Inf (${lBL})`, data: lowerSeriesData }, false); 
                         chartInstance.series[4].setData(zSeriesData, true); 
                     } else { 
                         if(chartInstance) { chartInstance.destroy(); } 
                         chartInstance = Highcharts.chart("chart-container", chartOptions); 
                     }
                } catch(error) { 
                     console.error("!!! Erreur renderOrUpdateChart:", error); 
                     showError(`Erreur graphique Z (Principal): ${error.message}`, false); 
                     if (chartContainer) chartContainer.innerHTML = `<p class="error">Impossible d'afficher graphique Z (Principal).</p>`; 
                     if (chartInstance) { try { chartInstance.destroy(); } catch(e) {} chartInstance = null; } 
                }
             }, 0);
        }
        function showError(message, hideResultsSectionIfVisible = true) { 
            errorDivGen.textContent = message; errorDivGen.style.display = 'block'; 
        } 
        
        function resetFullAnalysis(confirmReset = true) { 
            if (confirmReset && !confirm("Êtes-vous sûr de vouloir réinitialiser toute l'analyse ? Toutes les données et configurations seront perdues.")) return;
            
            mdeCalcForm.reset(); 
            dataForm.reset(); 
            
            currentDesignParams = null; currentBoundariesApiResultPrincipal = null; currentBoundariesApiResultSecondary = null;
            weeklyEnteredData = []; observedZDataPrincipal = []; observedZDataSecondary = [];
            
            baselineSecondaryKpiGroup.style.display = 'none'; 
            toggleBaselineSecondaryKpiLink.textContent = 'Ajouter un KPI de sécurité (planification)';
            mdeTableSecondaryColHeader.style.display = 'none'; 
            isSecondaryKpiPlanned = false;
            
            mdeResultsDiv.style.display = 'none'; mdeForecastTbody.innerHTML = ''; mdeErrorDiv.textContent = ''; mdeErrorDiv.style.display = 'none';
            baselineTrafficInfo.style.display = 'none'; baselineTrafficInfo.textContent = '';
            baselineTotalConversionsInfo.style.display = 'none'; baselineTotalConversionsInfo.textContent = '';
            if (baselineTotalConversionsSecondaryInfo) {
                baselineTotalConversionsSecondaryInfo.style.display = 'none'; baselineTotalConversionsSecondaryInfo.textContent = '';
            }

            dataEntrySection.style.display = 'none'; 
            dataEntryTitle.textContent = 'Étape 2 : Saisie des Données';
            historySection.style.display = 'none'; 
            toggleHistoryTableLink.textContent = "Modifier l'historique des données";
            historyTbody.innerHTML = ''; srmWarningDiv.style.display = 'none';
            
            resultsDiv.style.display = 'none'; 
            if (principalDetailsContainer) principalDetailsContainer.style.display = 'none';
            if (togglePrincipalDetailsLink) togglePrincipalDetailsLink.textContent = 'Voir plus de détails';
            if (secondaryDetailsContainer) secondaryDetailsContainer.style.display = 'none';
            if (toggleSecondaryDetailsLink) toggleSecondaryDetailsLink.textContent = 'Voir plus de détails';

            errorDivGen.textContent = ''; errorDivGen.style.display = 'none';
            decisionDiv.textContent = ''; decisionDiv.className = 'alert col-md-4'; 
            
            if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
            if (chartContainer) chartContainer.innerHTML = ''; 
            if (boundariesTbody) boundariesTbody.innerHTML = '';
            if (liftVisualizationTbody) liftVisualizationTbody.innerHTML = '';
            Object.values(liftChartInstances).forEach(chart => { if (chart && typeof chart.destroy === 'function') chart.destroy(); });
            liftChartInstances = {};
            if (progressGaugeInstance) { progressGaugeInstance.destroy(); progressGaugeInstance = null; }
            if(testProgressGaugeContainer) testProgressGaugeContainer.innerHTML = '';

            testProgressPercentageSpan.textContent = 'N/A'; // MODIFICATION
            srmCheckIndicator.textContent = 'N/A'; srmCheckIndicator.className = '';
            projectedGainDisplay.style.display = 'none';

            if(startAnalysisHelpText) startAnalysisHelpText.textContent = "Renseignez les données de base pour estimer la durée/MDE.";
            startAnalysisButton.disabled = true; 
            addDataButton.disabled = true;
            
            if (testNameTopInput) testNameTopInput.value = "";
            if(testStartDateInput) testStartDateInput.value = new Date().toISOString().split('T')[0];


            if (!collapseMDE.classList.contains('show')) { $(collapseMDE).collapse('show'); }
            
            calculateAndDisplayMDEForecast(); 
            if (!confirmReset) updateSavedTestsList(); 
        }

        function checkSRM(tA, tB) { 
            if (!srmCheckIndicator) { return; }
            if ((tA === undefined || isNaN(tA) || tA === 0) && (tB === undefined || isNaN(tB) || tB === 0)) { 
                srmCheckIndicator.textContent = 'N/A'; srmCheckIndicator.className = ''; 
                if(srmWarningDiv) srmWarningDiv.style.display = 'none'; 
                return; 
            }
            const tot = tA + tB; 
            if (tot === 0) { 
                srmCheckIndicator.textContent = 'N/A'; srmCheckIndicator.className = ''; 
                if(srmWarningDiv) srmWarningDiv.style.display = 'none'; 
                return; 
            }
            const expA = tot * 0.5; const expB = tot * 0.5;
            const chi2 = ((tA - expA)**2 / expA) + ((tB - expB)**2 / expB);
            const isSRM = chi2 > 3.841; 
            if(srmWarningDiv) srmWarningDiv.style.display = isSRM ? 'block' : 'none';
            if(isSRM) {
                srmCheckIndicator.innerHTML = '⚠️ Erreur SRM';
                srmCheckIndicator.className = 'srm-error';
            } else {
                srmCheckIndicator.innerHTML = '✅ Ok';
                srmCheckIndicator.className = 'srm-ok';
            }
        } 
        // MODIFICATION START: Jauge de progression
        function renderProgressGauge(current, total) { 
            if (!testProgressGaugeContainer) { return;}
            testProgressGaugeContainer.style.display = 'block'; 
            const percentage = total > 0 ? Math.min(100, (current / total) * 100) : 0;
            
            // Mise à jour du texte JJ/JJ
            const daysPerWeek = 7;
            const daysDone = current * daysPerWeek;
            const totalDays = total * daysPerWeek;
            const daysRemaining = totalDays - daysDone;
            testProgressPercentageSpan.textContent = `${daysDone} / ${totalDays} jours`;


            if (document.hidden) { return; }

            setTimeout(() => {
                try {
                    if (progressGaugeInstance && progressGaugeInstance.series) {
                        progressGaugeInstance.series[0].setData([100 - percentage], false); 
                        progressGaugeInstance.series[1].setData([percentage], true);      
                    } else {
                        if (progressGaugeInstance) progressGaugeInstance.destroy(); // Détruire l'ancienne instance si elle existe
                        progressGaugeInstance = Highcharts.chart(testProgressGaugeContainer.id, {
                            chart: { 
                                type: 'bar', 
                                height: 20, 
                                backgroundColor: 'transparent', 
                                margin: [0,0,0,0],
                                width: 120 // Largeur fixe
                            },
                            title: { text: null },
                            xAxis: { visible: false, categories: [''] },
                            yAxis: { visible: false, min: 0, max: 100, stackLabels: { enabled: false } }, 
                            legend: { enabled: false },
                            tooltip: { enabled: false },
                            plotOptions: {
                                bar: {
                                    stacking: 'percent',
                                    borderWidth: 0,
                                    pointPadding: 0,
                                    groupPadding: 0,
                                    dataLabels: { enabled: false } // Texte en % dans la jauge supprimé
                                }
                            },
                            series: [{
                                name: 'Restant', 
                                data: [100 - percentage],
                                color: 'var(--progress-gauge-todo-color)', // Couleur pour "à faire"
                                enableMouseTracking: false,
                            },{
                                name: 'Progression',
                                data: [percentage],
                                color: 'var(--progress-gauge-done-color)', // Couleur pour "fait"
                                enableMouseTracking: false,
                            }],
                            credits: { enabled: false }
                        });
                    }
                } catch (e) {
                    console.error("Erreur rendu jauge de progression:", e);
                    testProgressGaugeContainer.innerHTML = "<span style='font-size:0.8em; color:red;'>Erreur jauge</span>";
                }
            }, 0);
        } 
        // MODIFICATION END
        
        function updateHistoryTable() { historyTbody.innerHTML = ''; let prevCumulA_P = 0; let prevVisitorsA = 0; let prevCumulB_P = 0; let prevVisitorsB = 0; let prevCumulA_S = 0; let prevCumulB_S = 0; weeklyEnteredData.forEach((data, index) => { const week = data.week; const incVisitorsA = data.visitorsACumul - prevVisitorsA; const incConvA_P = data.conversionsACumul_P - prevCumulA_P; const incVisitorsB = data.visitorsBCumul - prevVisitorsB; const incConvB_P = data.conversionsBCumul_P - prevCumulB_P; const rateA_P = incVisitorsA > 0 ? (incConvA_P / incVisitorsA) * 100 : 0; const rateB_P = incVisitorsB > 0 ? (incConvB_P / incVisitorsB) * 100 : 0; let secondaryHtmlA = ''; let secondaryHtmlB = ''; if (isSecondaryKpiPlanned) { const incConvA_S = (data.conversionsASecondaryCumul !== undefined ? data.conversionsASecondaryCumul : 0) - prevCumulA_S; const incConvB_S = (data.conversionsBSecondaryCumul !== undefined ? data.conversionsBSecondaryCumul : 0) - prevCumulB_S; const rateA_S = incVisitorsA > 0 ? (incConvA_S / incVisitorsA) * 100 : 0; const rateB_S = incVisitorsB > 0 ? (incConvB_S / incVisitorsB) * 100 : 0; secondaryHtmlA = `<td style="${historyTableSecondaryConvHeader.style.display}">${formatNumberForDisplay(incConvA_S,0)}</td><td style="${historyTableSecondaryRateHeader.style.display}">${formatNumberForDisplay(rateA_S,2)}</td>`; secondaryHtmlB = `<td style="${historyTableSecondaryConvHeader.style.display}">${formatNumberForDisplay(incConvB_S,0)}</td><td style="${historyTableSecondaryRateHeader.style.display}">${formatNumberForDisplay(rateB_S,2)}</td>`; prevCumulA_S = data.conversionsASecondaryCumul !== undefined ? data.conversionsASecondaryCumul : prevCumulA_S; prevCumulB_S = data.conversionsBSecondaryCumul !== undefined ? data.conversionsBSecondaryCumul : prevCumulB_S; } const rowA = `<tr> <td rowspan="${weeklyEnteredData.length > 0 ? 2:1}" style="vertical-align: middle;">${week}</td> <td class="variation-label">A</td> <td>${incVisitorsA}</td> <td>${formatNumberForDisplay(incConvA_P,0)}</td> <td>${formatNumberForDisplay(rateA_P,2)}</td> ${secondaryHtmlA} <td rowspan="2" style="vertical-align: middle;"> <button class="btn btn-danger btn-sm" onclick="deleteWeeklyCumulativeData(${index})" title="Supprimer cette semaine et les suivantes">X</button> </td> </tr>`; const rowB = `<tr> <td class="variation-label">B</td> <td>${incVisitorsB}</td> <td>${formatNumberForDisplay(incConvB_P,0)}</td> <td>${formatNumberForDisplay(rateB_P,2)}</td> ${secondaryHtmlB} </tr>`; historyTbody.innerHTML += rowA + rowB; prevVisitorsA = data.visitorsACumul; prevCumulA_P = data.conversionsACumul_P; prevVisitorsB = data.visitorsBCumul; prevCumulB_P = data.conversionsBCumul_P; }); } 

        window.deleteWeeklyCumulativeData = function(idxToDelete) { 
            if (confirm(`Supprimer les données de la semaine ${weeklyEnteredData[idxToDelete].week} et toutes les semaines suivantes ?`)) { 
                weeklyEnteredData.splice(idxToDelete); 
                observedZDataPrincipal.splice(idxToDelete); 
                observedZDataSecondary.splice(idxToDelete); 
                
                if (weeklyEnteredData.length === 0) {
                    resultsDiv.style.display = 'none';
                }

                triggerApiRecalculation(); 
                updateHistoryTable(); 
                checkIfDataEntryShouldBeEnabled(); 
                updateDataEntryTitle(); 
            } 
        } 
        async function triggerApiRecalculation() { 
            loadingDiv.style.display = 'block'; 
            addDataButton.disabled = true; 
            if (weeklyEnteredData.length === 0) { 
                if (currentDesignParams) { 
                    observedZDataPrincipal = new Array(currentDesignParams.k).fill(null); 
                    observedZDataSecondary = new Array(currentDesignParams.k).fill(null); 
                    currentBoundariesApiResultPrincipal = await (await fetch(apiUrlInput.value, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ k: currentDesignParams.k, alpha: currentDesignParams.alpha, power: currentDesignParams.power, sfu: currentDesignParams.sfu, sfl: currentDesignParams.sfl, testType: currentDesignParams.testTypePrincipal }) })).json();
                    if (isSecondaryKpiPlanned) {
                         currentBoundariesApiResultSecondary = await (await fetch(apiUrlInput.value, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ k: currentDesignParams.k, alpha: currentDesignParams.alpha, power: currentDesignParams.power, sfu: currentDesignParams.sfu, sfl: currentDesignParams.sfl, testType: TEST_TYPE_SECONDARY_DEFAULT }) })).json();
                    } else {
                        currentBoundariesApiResultSecondary = null;
                    }
                    displayApiResults(); 
                }
                prepareNextDataEntry(); 
                updateDataEntryTitle(); // Mettre à jour le titre même si pas de données
            } else { 
                const lastData = weeklyEnteredData[weeklyEnteredData.length - 1]; 
                controlVisitorsInput.value = lastData.visitorsACumul; 
                controlConversionsInput.value = lastData.conversionsACumul_P; 
                variantVisitorsInput.value = lastData.visitorsBCumul; 
                variantConversionsInput.value = lastData.conversionsBCumul_P; 
                if (isSecondaryKpiPlanned) { 
                    controlConversionsSecondaryInput.value = lastData.conversionsASecondaryCumul !== undefined ? lastData.conversionsASecondaryCumul : ''; 
                    variantConversionsSecondaryInput.value = lastData.conversionsBSecondaryCumul !== undefined ? lastData.conversionsBSecondaryCumul : ''; 
                } 
                await handleAddOrUpdateCumulativeData(); 
            } 
            loadingDiv.style.display = 'none'; 
            addDataButton.disabled = false; 
        } 
        
        function saveCurrentTestState() { if (!testNameTopInput.value) { alert("Veuillez nommer le test."); return; } const testState = { name: testNameTopInput.value, timestamp: new Date().toISOString(), baselineTraffic: baselineTrafficInput.value, baselineTotalConversions: baselineTotalConversionsInput.value, baselineTotalConversionsSecondary: baselineTotalConversionsSecondaryInput.value, isSecondaryKpiPlanned, testStartDate: testStartDateInput.value, mdeConfidence: mdeConfidenceSelect.value, mdePower: mdePowerSelect.value, mdeTestType: mdeTestTypeSelect.value, designSpendingFunction: designSpendingFunctionSelect.value, designSpendingFunctionLower: designSpendingFunctionLowerSelect.value, designK: designKInput.value, currentDesignParams, currentBoundariesApiResultPrincipal, currentBoundariesApiResultSecondary, weeklyEnteredData, observedZDataPrincipal, observedZDataSecondary, apiUrl: apiUrlInput.value }; try { localStorage.setItem(STORAGE_PREFIX + testNameTopInput.value, JSON.stringify(testState)); alert(`Test "${testNameTopInput.value}" sauvegardé.`); updateSavedTestsList(); } catch (e) { if (e.name === 'QuotaExceededError') { alert("Erreur de sauvegarde : Quota de stockage local dépassé. Veuillez supprimer d'anciens tests."); } else { alert("Erreur de sauvegarde : " + e.message); } } }
        async function loadSelectedTestState() { const testNameToLoad = savedTestsListTop.value; if (!testNameToLoad) { alert("Sélectionnez un test à charger."); return; } const savedStateJSON = localStorage.getItem(STORAGE_PREFIX + testNameToLoad); if (!savedStateJSON) { alert("Test non trouvé."); return; } resetFullAnalysis(false); try { const savedState = JSON.parse(savedStateJSON); testNameTopInput.value = savedState.name || ''; baselineTrafficInput.value = savedState.baselineTraffic || ''; baselineTotalConversionsInput.value = savedState.baselineTotalConversions || ''; baselineTotalConversionsSecondaryInput.value = savedState.baselineTotalConversionsSecondary || ''; isSecondaryKpiPlanned = savedState.isSecondaryKpiPlanned === true; baselineSecondaryKpiGroup.style.display = isSecondaryKpiPlanned ? 'block' : 'none'; toggleBaselineSecondaryKpiLink.textContent = isSecondaryKpiPlanned ? 'Retirer le KPI de sécurité (planification)' : 'Ajouter un KPI de sécurité (planification)'; testStartDateInput.value = savedState.testStartDate || new Date().toISOString().split('T')[0];  mdeConfidenceSelect.value = savedState.mdeConfidence || '0.05'; mdePowerSelect.value = savedState.mdePower || '0.80'; mdeTestTypeSelect.value = savedState.mdeTestType || '3'; designSpendingFunctionSelect.value = savedState.designSpendingFunction || 'KimDeMets'; designSpendingFunctionLowerSelect.value = savedState.designSpendingFunctionLower || 'HSD'; designKInput.value = savedState.designK || ''; apiUrlInput.value = savedState.apiUrl || "https://my-gst-api.onrender.com/api/calculate-boundaries"; if (baselineTrafficInput.value && baselineTotalConversionsInput.value) { calculateAndDisplayMDEForecast(); } if (savedState.designK) { applyKHighlight(savedState.designK); checkIfStartAnalysisCanBeEnabled(); } if (savedState.currentDesignParams) { currentDesignParams = savedState.currentDesignParams; currentBoundariesApiResultPrincipal = savedState.currentBoundariesApiResultPrincipal; currentBoundariesApiResultSecondary = savedState.currentBoundariesApiResultSecondary; observedZDataPrincipal = savedState.observedZDataPrincipal || []; observedZDataSecondary = savedState.observedZDataSecondary || []; weeklyEnteredData = savedState.weeklyEnteredData || []; if (weeklyEnteredData.length > 0) { resultsDiv.style.display = 'block'; } dataEntrySection.style.display = 'block'; updateDataEntryTitle();  secondaryMetricInputsA.style.display = isSecondaryKpiPlanned ? 'block' : 'none'; secondaryMetricInputsB.style.display = isSecondaryKpiPlanned ? 'block' : 'none'; historyTableSecondaryHeaderGroup.style.display = isSecondaryKpiPlanned ? 'table-cell' : 'none'; historyTableSecondaryConvHeader.style.display = isSecondaryKpiPlanned ? 'table-cell' : 'none'; historyTableSecondaryRateHeader.style.display = isSecondaryKpiPlanned ? 'table-cell' : 'none'; displayBoundariesTableAndChart(); displayApiResults(); checkIfDataEntryShouldBeEnabled(); const lastData = weeklyEnteredData.length > 0 ? weeklyEnteredData[weeklyEnteredData.length - 1] : null; if (lastData) { controlVisitorsInput.value = lastData.visitorsACumul; controlConversionsInput.value = lastData.conversionsACumul_P; variantVisitorsInput.value = lastData.visitorsBCumul; variantConversionsInput.value = lastData.conversionsBCumul_P; if (isSecondaryKpiPlanned) { controlConversionsSecondaryInput.value = lastData.conversionsASecondaryCumul !== undefined ? lastData.conversionsASecondaryCumul : ''; variantConversionsSecondaryInput.value = lastData.conversionsBSecondaryCumul !== undefined ? lastData.conversionsBSecondaryCumul : ''; } } } alert(`Test "${testNameToLoad}" chargé.`); } catch (e) { alert("Erreur chargement test: " + e.message); resetFullAnalysis(false); } }
        function deleteSelectedTestState() { const testNameToDelete = savedTestsListTop.value; if (!testNameToDelete) { alert("Sélectionnez un test à supprimer."); return; } if (confirm(`Supprimer le test "${testNameToDelete}" ?`)) { localStorage.removeItem(STORAGE_PREFIX + testNameToDelete); alert(`Test "${testNameToDelete}" supprimé.`); updateSavedTestsList(); } }
        function updateSavedTestsList() { savedTestsListTop.innerHTML = '<option value="">-- Charger un test --</option>'; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith(STORAGE_PREFIX)) { const testName = key.substring(STORAGE_PREFIX.length); const option = document.createElement('option'); option.value = testName; option.textContent = testName; savedTestsListTop.appendChild(option); } } }

        // --- Initial State Setup ---
        startAnalysisButton.disabled = true; 
        addDataButton.disabled = true; 
        if(startAnalysisHelpText) startAnalysisHelpText.textContent = "Renseignez les données de base pour estimer la durée/MDE.";
        updateSavedTestsList(); 
        
        baselineSecondaryKpiGroup.style.display = 'none'; 
        toggleBaselineSecondaryKpiLink.textContent = 'Ajouter un KPI de sécurité (planification)';
        mdeTableSecondaryColHeader.style.display = 'none'; 
        isSecondaryKpiPlanned = false;

        secondaryMetricInputsA.style.display = 'none'; 
        secondaryMetricInputsB.style.display = 'none';
        historyTableSecondaryHeaderGroup.style.display = 'none'; 
        historyTableSecondaryConvHeader.style.display = 'none';
        historyTableSecondaryRateHeader.style.display = 'none';

        historySection.style.display = 'none'; 
        toggleHistoryTableLink.textContent = "Modifier l'historique des données";

        boundariesTableContainer.style.display = 'none'; 
        toggleBoundariesTableLink.textContent = "Voir les bornes séquentielles (Obj. Principal)";
        if(liftVisualizationTbody) renderLiftVisualizationChart([{name: 'Principal', lift:null, ci_low:null, ci_high:null, crA: null, crB: null}]); 
        testProgressPercentageSpan.textContent = 'N/A'; 
        srmCheckIndicator.textContent = 'N/A'; srmCheckIndicator.className = '';
        if(testProgressGaugeContainer) renderProgressGauge(0, 1); 

        if (calculateMdeButton) calculateMdeButton.style.display = 'none';
        
        resultsDiv.style.display = 'none';
        if (principalDetailsContainer) principalDetailsContainer.style.display = 'none';
        if (togglePrincipalDetailsLink) togglePrincipalDetailsLink.textContent = 'Voir plus de détails';
        if (secondaryDetailsContainer) secondaryDetailsContainer.style.display = 'none';
        if (toggleSecondaryDetailsLink) toggleSecondaryDetailsLink.textContent = 'Voir plus de détails';
        
        if(testStartDateInput) testStartDateInput.value = new Date().toISOString().split('T')[0];

        calculateAndDisplayMDEForecast(); 


    }); // Fin DOMContentLoaded
  </script>

</body>
</html>